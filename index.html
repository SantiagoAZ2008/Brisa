<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Brisa ‚Ä¢ Dashboard</title>
<style>
  :root{
    --bg:#071017;
    --panel: rgba(255,255,255,0.03);
    --muted: rgba(230,238,246,0.7);
    --accent:#ff4d7a;
    --accent2:#7be2ff;
    --success:#44d69e;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
    color:#eaf0f8; background:var(--bg); overflow:hidden;
  }

  /* Background canvas */
  canvas#bg { position:fixed; inset:0; width:100%; height:100%; z-index:0; display:block; }

  /* Layout */
  .app { position:relative; z-index:2; display:grid; grid-template-columns: 84px 1fr; height:100vh; }
  .sidebar {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-right: 1px solid rgba(255,255,255,0.03);
    display:flex; flex-direction:column; align-items:center; gap:10px; padding:18px 8px;
  }
  .logo { width:54px;height:54px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#9f6bff);display:flex;align-items:center;justify-content:center;font-weight:900;color:white;font-size:18px;box-shadow:0 8px 20px rgba(0,0,0,0.6); }
  .sideBtn { width:100%; display:flex; flex-direction:column; align-items:center; gap:6px; padding:8px; cursor:pointer; border-radius:10px; background:transparent; border:none; color:inherit; }
  .sideBtn:hover{ background: rgba(255,255,255,0.02); transform:translateX(6px); }
  .sideBtn.active{ background: linear-gradient(90deg, rgba(255,77,122,0.08), rgba(123,226,255,0.03)); }

  /* label under icon */
  .iconLabel { font-size:11px; color:var(--muted); }

  /* Top bar inside main */
  .main {
    padding:18px; overflow:auto;
  }
  .topBar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:16px; }
  .title { font-size:20px; font-weight:700; }
  .subtitle { color:var(--muted); font-size:13px; }

  /* content area */
  .content { display:grid; grid-template-columns: 1fr 360px; gap:16px; align-items:start; }
  .panel {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:12px; padding:14px; box-shadow:0 12px 30px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.02);
  }
  .wide { grid-column: 1 / -1; }

  /* controls */
  input, select { background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); color:inherit; padding:10px; border-radius:8px; width:100%; }
  button.btn { padding:10px 14px; border-radius:10px; background:var(--accent); color:white; border:none; cursor:pointer; font-weight:700; }
  button.btn.alt { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); }

  /* games */
  .gameArea { min-height:180px; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px; }

  /* memory grid */
  .mem-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:12px; }
  .mem-card { background: rgba(255,255,255,0.02); border-radius:8px; padding:18px; text-align:center; font-size:20px; cursor:pointer; user-select:none; transition: transform .12s; }
  .mem-card.revealed { transform:scale(1.04); background: linear-gradient(135deg, rgba(255,77,122,0.12), rgba(123,226,255,0.06)); }

  /* right column */
  .stat { display:flex; justify-content:space-between; padding:10px; border-radius:8px; background: rgba(255,255,255,0.01); margin-bottom:8px; }

  /* footer small */
  .footerMini { position:fixed; left:50%; transform:translateX(-50%); bottom:10px; background:rgba(0,0,0,0.45); padding:8px 12px; border-radius:12px; font-size:13px; color:var(--muted); z-index:4; }

  /* login modal */
  .modalBg { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:30; }
  .modal { background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); padding:20px; border-radius:12px; width:420px; box-shadow:0 20px 60px rgba(0,0,0,0.7); border:1px solid rgba(255,255,255,0.02); }
  .modal h2{ margin-bottom:8px }
  .modal .switch { font-size:13px; color:var(--muted); margin-top:8px; cursor:pointer; text-decoration:underline; }

  /* small responsive */
  @media (max-width:900px){
    .app { grid-template-columns: 72px 1fr; }
    .content { grid-template-columns: 1fr; }
    .mem-grid { grid-template-columns: repeat(2,1fr); }
  }
</style>
</head>
<body>

<canvas id="bg"></canvas>

<div class="app">
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="logo">B+</div>
    <button class="sideBtn active" data-view="home" title="Inicio">
      <!-- simple home icon -->
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none"><path d="M3 10.5L12 4l9 6.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      <div class="iconLabel">Inicio</div>
    </button>

    <button class="sideBtn" data-view="games" title="Juegos">
      <svg width="24" height="24" viewBox="0 0 24 24"><path d="M6 12h12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      <div class="iconLabel">Juegos</div>
    </button>

    <button class="sideBtn" data-view="journal" title="Historial">
      <svg width="24" height="24" viewBox="0 0 24 24"><path d="M7 11h10" stroke="currentColor" stroke-width="1.5"/></svg>
      <div class="iconLabel">Historial</div>
    </button>

    <button class="sideBtn" data-view="invites" title="Invitaciones">
      <svg width="24" height="24" viewBox="0 0 24 24"><path d="M3 8h18" stroke="currentColor" stroke-width="1.5"/></svg>
      <div class="iconLabel">Invites</div>
    </button>

    <div style="flex:1"></div>

    <button class="sideBtn" id="profileBtn" title="Perfil">
      <svg width="24" height="24" viewBox="0 0 24 24"><circle cx="12" cy="8" r="3" stroke="currentColor" stroke-width="1.5"/><path d="M4 20c1.7-4 6-6 8-6s6.3 2 8 6" stroke="currentColor" stroke-width="1.5"/></svg>
      <div class="iconLabel">Perfil</div>
    </button>

  </aside>

  <!-- MAIN -->
  <main class="main">
    <div class="topBar">
      <div>
        <div class="title" id="pageTitle">Inicio</div>
        <div class="subtitle" id="pageSub">Un espacio grande ‚Äî dise√±ado para ser bacano. (Inicia sesi√≥n o reg√≠strate)</div>
      </div>
      <div style="display:flex;align-items:center;gap:10px">
        <label style="color:var(--muted);font-size:13px">Sonido <input id="soundToggle" type="checkbox" checked style="margin-left:6px" /></label>
        <button id="logout" class="btn alt" style="display:none">Cerrar sesi√≥n</button>
      </div>
    </div>

    <div class="content">
      <!-- Left column -->
      <div>
        <div class="panel">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
              <div style="font-weight:800;font-size:16px">Resumen r√°pido</div>
              <div style="color:var(--muted);font-size:13px">Estad√≠sticas y actividad</div>
            </div>
            <div style="text-align:right;color:var(--muted);font-size:13px" id="userInfoSmall">Invitado</div>
          </div>

          <div style="display:flex;gap:12px;margin-top:12px">
            <div style="flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01)">
              <div style="font-size:22px;font-weight:800" id="statUsers">0</div><div style="font-size:12px;color:var(--muted)">Usuarios</div>
            </div>
            <div style="flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01)">
              <div style="font-size:22px;font-weight:800" id="statRecords">0</div><div style="font-size:12px;color:var(--muted)">Registros</div>
            </div>
            <div style="flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01)">
              <div style="font-size:22px;font-weight:800" id="statCodes">0</div><div style="font-size:12px;color:var(--muted)">Invitaciones</div>
            </div>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:700">Actividad reciente</div>
            <div id="recent" style="margin-top:8px;color:var(--muted);font-size:13px">‚Äî ninguna ‚Äî</div>
          </div>
        </div>

        <div class="panel" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:800">Panel r√°pido</div>
            <div style="color:var(--muted);font-size:13px">Acciones</div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <input id="quickUser" type="text" placeholder="Usuario" />
            <input id="quickPass" type="password" placeholder="Contrase√±a" style="width:160px"/>
            <button id="quickLogin" class="btn">Entrar</button>
            <button id="quickReg" class="btn alt">Registrar</button>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button id="demoBtn" class="btn alt">Demo</button>
            <button id="exportBtn" class="btn">Exportar</button>
            <button id="redeemBtn" class="btn alt">Canjear</button>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:700">Guardar emoci√≥n r√°pida</div>
            <div style="display:flex;gap:8px;margin-top:8px">
              <select id="fastEmotion"><option>Feliz</option><option>Triste</option><option>Ansioso</option><option>Calmado</option><option>Motivado</option></select>
              <button id="saveEmotion" class="btn">Guardar</button>
            </div>
          </div>
        </div>

        <!-- area where pages render -->
        <div id="pageArea" style="margin-top:12px"></div>

      </div>

      <!-- Right column -->
      <aside class="panel">
        <div style="font-weight:800">Mini-juegos</div>
        <div style="display:flex;gap:8px;margin-top:10px">
          <button class="btn alt gameBtn" data-game="reaction">Reacci√≥n</button>
          <button class="btn alt gameBtn" data-game="memory">Memoria</button>
          <button class="btn alt gameBtn" data-game="breath">Respiraci√≥n</button>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:800">Invitaciones</div>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button id="genCode" class="btn">Generar</button>
            <button id="showCodes" class="btn alt">Ver</button>
          </div>
          <div id="codesList" style="margin-top:8px;color:var(--muted)">‚Äî ninguno ‚Äî</div>
        </div>

        <div style="margin-top:12px">
          <div style="font-weight:800">Sesi√≥n</div>
          <div style="margin-top:6px">Usuario: <strong id="activeUser">‚Äî</strong></div>
          <div style="margin-top:6px;color:var(--muted)" id="createdAt">‚Äî</div>
        </div>

      </aside>

    </div>

  </main>
</div>

<div class="footerMini" id="miniFooter">¬© Brisa ‚Ä¢ Derechos reservados ‚Ä¢ <span style="color:var(--accent)">@sa_mejia.e</span></div>

<!-- LOGIN / REGISTER MODAL (shows on load if not logged) -->
<div id="loginModal" class="modalBg" style="display:none;">
  <div class="modal">
    <h2 id="modalTitle">Iniciar sesi√≥n</h2>
    <input id="modalUser" type="text" placeholder="Usuario" />
    <input id="modalPass" type="password" placeholder="Contrase√±a" style="margin-top:8px" />
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="modalLogin" class="btn">Entrar</button>
      <button id="modalToRegister" class="btn alt">Registrar</button>
    </div>
    <div id="modalMsg" style="margin-top:10px;color:var(--muted)"></div>
    <div class="switch" id="modalSwitch">¬øNo tienes cuenta? Reg√≠strate</div>
  </div>
</div>

<script>
/* ---------------------------
  Brisa final ‚Äî one-file app
   - sidebar left
   - animated camuflaje bg
   - login/register modal mandatory
   - games, invites, history
   - localStorage persistence
---------------------------- */

const $ = id => document.getElementById(id);
const q = sel => document.querySelector(sel);
const qAll = sel => document.querySelectorAll(sel);

const STORE = 'brisa_final_v1';

// Background canvas (single layered but damasco vibe)
const canvas = $('bg'); const ctx = canvas.getContext('2d');
function resize() {
  canvas.width = innerWidth * devicePixelRatio;
  canvas.height = innerHeight * devicePixelRatio;
  canvas.style.width = innerWidth+'px';
  canvas.style.height = innerHeight+'px';
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
resize(); window.addEventListener('resize', resize);

// blobs
const blobs = [];
const palette = ['#37202b','#7a263f','#b43b5a','#12202a'];
for(let i=0;i<20;i++){
  blobs.push({ x: Math.random()*innerWidth, y: Math.random()*innerHeight, r: 80 + Math.random()*220, vx:(Math.random()-0.5)*0.25, vy:(Math.random()-0.5)*0.25, c: palette[i%palette.length] });
}
let t0 = performance.now();
function draw(now){
  const t = (now - t0) * 0.0006;
  ctx.clearRect(0,0,innerWidth,innerHeight);
  // radial blobs
  blobs.forEach((b, i)=>{
    b.x += b.vx * Math.cos(t*(0.4 + i*0.02));
    b.y += b.vy * Math.sin(t*(0.3 + i*0.02));
    const g = ctx.createRadialGradient(b.x, b.y, b.r*0.05, b.x, b.y, b.r);
    g.addColorStop(0, hexRgba(b.c, 0.16));
    g.addColorStop(1, hexRgba(b.c, 0.02));
    ctx.beginPath(); ctx.fillStyle = g; ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill();
  });
  // subtle grain
  for(let i=0;i<600;i++){
    ctx.fillStyle = `rgba(255,255,255,${(Math.random()-0.97)*0.02})`;
    ctx.fillRect(Math.random()*innerWidth, Math.random()*innerHeight, 1,1);
  }
  requestAnimationFrame(draw);
}
requestAnimationFrame(draw);
function hexRgba(hex,a){ const c = hex.replace('#',''); const n = parseInt(c,16); const r=(n>>16)&255,g=(n>>8)&255,b=n&255; return `rgba(${r},${g},${b},${a})`; }

/* Storage helpers */
function readStore(){ return JSON.parse(localStorage.getItem(STORE) || '[]'); }
function writeStore(data){ localStorage.setItem(STORE, JSON.stringify(data)); refreshStats(); }

/* Auth & UI wiring */
let current = localStorage.getItem('brisa_final_active') || '';

function requireAuthModal(){
  if(!current){
    $('loginModal').style.display='flex';
    $('modalTitle').textContent='Iniciar sesi√≥n';
    $('modalMsg').textContent='Debes iniciar sesi√≥n o registrarte para usar Brisa.';
  } else {
    $('loginModal').style.display='none';
  }
}
requireAuthModal();

function setActive(u){
  if(u){ localStorage.setItem('brisa_final_active', u); current = u; } else { localStorage.removeItem('brisa_final_active'); current=''; }
  refreshSession();
  requireAuthModal();
}

/* modal events */
$('modalSwitch').addEventListener('click', ()=>{
  if($('modalTitle').textContent.includes('Iniciar')) {
    $('modalTitle').textContent='Registrar cuenta';
    $('modalToRegister').style.display='none';
    $('modalLogin').textContent='Registrar';
    $('modalSwitch').textContent = '¬øYa tienes cuenta? Iniciar sesi√≥n';
  } else {
    $('modalTitle').textContent='Iniciar sesi√≥n';
    $('modalToRegister').style.display='inline-block';
    $('modalLogin').textContent='Entrar';
    $('modalSwitch').textContent = '¬øNo tienes cuenta? Reg√≠strate';
  }
});

/* modal primary button handles both login and register depending title */
$('modalLogin').addEventListener('click', ()=>{
  const u = $('modalUser').value.trim(); const p = $('modalPass').value.trim();
  if(u.length<3 || p.length<3){ $('modalMsg').textContent='Usuario/contrase√±a m√≠nimo 3 caracteres'; return; }
  const users = readStore();
  if($('modalTitle').textContent.includes('Iniciar')){
    const found = users.find(x=>x.user===u && x.pass===p);
    if(found){ setActive(u); $('modalMsg').textContent='Bienvenido '+u; $('loginModal').style.display='none'; $('modalUser').value=''; $('modalPass').value=''; } else { $('modalMsg').textContent='Usuario o contrase√±a incorrectos'; }
  } else {
    if(users.find(x=>x.user===u)){ $('modalMsg').textContent='Usuario ya existe'; return; }
    users.push({ user:u, pass:p, created:new Date().toISOString(), history:[], invites:[] });
    writeStore(users); setActive(u); $('modalMsg').textContent='Registrado ‚úì'; $('loginModal').style.display='none'; $('modalUser').value=''; $('modalPass').value=''; }
});

/* optional quick register button */
$('modalToRegister').addEventListener('click', ()=>{ $('modalTitle').textContent='Registrar cuenta'; $('modalLogin').textContent='Registrar'; $('modalToRegister').style.display='none'; $('modalSwitch').textContent='¬øYa tienes cuenta? Iniciar sesi√≥n'; });

/* quick panel login/register */
$('quickLogin').addEventListener('click', ()=>{
  const u = $('quickUser').value.trim(), p = $('quickPass').value.trim();
  if(u.length<3||p.length<3){ setMsg('Usuario/contrase√±a 3+','error'); return; }
  const users = readStore(); const f = users.find(x=>x.user===u && x.pass===p);
  if(f){ setActive(u); setMsg('Bienvenido '+u,'success'); $('quickUser').value=''; $('quickPass').value=''; } else setMsg('Credenciales inv√°lidas','error');
});
$('quickReg').addEventListener('click', ()=>{
  const u = $('quickUser').value.trim(), p = $('quickPass').value.trim();
  if(u.length<3||p.length<3){ setMsg('Usuario/contrase√±a 3+','error'); return; }
  const users = readStore(); if(users.find(x=>x.user===u)){ setMsg('Usuario ya existe','error'); return; }
  users.push({ user:u, pass:p, created:new Date().toISOString(), history:[], invites:[] }); writeStore(users); setActive(u); setMsg('Registrado y conectado','success'); $('quickUser').value=''; $('quickPass').value='';
});

/* logout */
$('logout').addEventListener('click', ()=>{ setActive(''); setMsg('Sesi√≥n cerrada','info'); });

/* demo */
$('demoBtn').addEventListener('click', ()=>{
  const users = readStore();
  if(users.length===0){
    users.push({ user:'alice', pass:'123', created:new Date().toISOString(), history:[{emotion:'Feliz',date:new Date().toISOString()}], invites:['ABC123']});
    users.push({ user:'santi', pass:'123', created:new Date().toISOString(), history:[{emotion:'Ansioso',date:new Date().toISOString()}], invites:[]});
    writeStore(users); setMsg('Demo cargada','success');
  } else setMsg('Datos ya existen','info');
});

/* export */
$('exportBtn').addEventListener('click', ()=>{ const d = JSON.stringify(readStore(),null,2); const b = new Blob([d],{type:'application/json'}); const url = URL.createObjectURL(b); const a = document.createElement('a'); a.href=url; a.download='brisa_data.json'; a.click(); URL.revokeObjectURL(url); setMsg('Exportado','info'); });

/* redeem prompt */
$('redeemBtn').addEventListener('click', ()=>{ const code = prompt('C√≥digo a canjear:'); if(!code) return; const users = readStore(); const owner = users.find(u=> (u.invites||[]).includes(code.trim().toUpperCase())); if(owner){ setMsg('C√≥digo v√°lido ‚Äî Bienvenido','success'); } else setMsg('C√≥digo inv√°lido','error'); });

/* save emotion quick */
$('saveEmotion').addEventListener('click', ()=>{
  const emo = $('fastEmotion').value;
  const u = localStorage.getItem('brisa_final_active') || '';
  if(!u){ setMsg('Inicia sesi√≥n para guardar','error'); return; }
  const users = readStore(); const user = users.find(x=>x.user===u);
  user.history = user.history || []; user.history.push({ emotion: emo, date: new Date().toISOString() }); writeStore(users); setMsg('Emoci√≥n guardada','success');
});

/* invite generation & show */
$('genCode').addEventListener('click', ()=>{
  const u = localStorage.getItem('brisa_final_active') || ''; if(!u){ setMsg('Inicia sesi√≥n para generar','error'); return; }
  const users = readStore(); const user = users.find(x=>x.user===u);
  const code = Math.random().toString(36).substring(2,9).toUpperCase();
  user.invites = user.invites || []; user.invites.push(code); writeStore(users); setMsg('C√≥digo: '+code,'success'); renderCodes();
});
$('showCodes').addEventListener('click', renderCodes);
function renderCodes(){
  const all = readStore().flatMap(u => (u.invites||[]).map(c=>({c, by:u.user})));
  if(all.length===0) $('codesList').textContent='‚Äî ninguno ‚Äî';
  else $('codesList').innerHTML = all.map(x=>`<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)"><strong>${x.c}</strong> ‚Ä¢ ${x.by}</div>`).join('');
}

/* games (buttons on right + nav) */
qAll('.gameBtn').forEach(b=> b.addEventListener('click', ()=> startGame(b.dataset.game)));
function startGame(name){
  if(!localStorage.getItem('brisa_final_active')){ setMsg('Inicia sesi√≥n para jugar','error'); return; }
  if(name==='reaction') startReaction();
  if(name==='memory') startMemory();
  if(name==='breath') startBreath();
}

/* reaction */
function startReaction(){
  $('pageArea').innerHTML = `<div class="panel"><div style="font-weight:800">Juego: Reacci√≥n</div><div class="gameArea" style="margin-top:12px"><button id="reactBtn" class="btn" style="padding:18px 30px">Preparar</button><div id="reactRes" style="color:var(--muted);margin-top:8px"></div></div></div>`;
  const btn = $('reactBtn'), res = $('reactRes');
  let start = null, timeoutId = null;
  btn.addEventListener('click', ()=>{
    btn.disabled=true; btn.textContent='Espera...'; btn.style.background='#333';
    timeoutId = setTimeout(()=>{ start = performance.now(); btn.disabled=false; btn.textContent='¬°Presiona!'; btn.style.background='var(--success)'; }, Math.random()*1800 + 700);
  });
  btn.addEventListener('click', ()=> {
    if(!start){ if(timeoutId) clearTimeout(timeoutId); btn.textContent='Preparar'; btn.style.background='var(--accent)'; res.textContent='Falso inicio'; addMiniHistory('Falso inicio (reacci√≥n)'); return; }
    const elapsed = Math.round(performance.now() - start); res.textContent = 'Tiempo: ' + elapsed + ' ms'; addMiniHistory('Reacci√≥n: '+elapsed+' ms'); storeMini({type:'reaction',value:elapsed}); start=null; btn.textContent='Preparar'; btn.style.background='var(--accent)';
  });
}

/* memory */
function startMemory(){
  const colors = ['üçÄ','üå∏','üåô','üî•','üíß','‚≠ê','üçé','‚ö°'];
  const deck = shuffle([...colors,...colors]);
  let first=null, second=null, locked=false, matched=0;
  $('pageArea').innerHTML = `<div class="panel"><div style="font-weight:800">Juego: Memoria</div><div class="mem-grid" id="memGrid" style="margin-top:12px"></div><div id="memMsg" style="margin-top:8px;color:var(--muted)"></div></div>`;
  const grid = $('memGrid');
  deck.forEach((v,i)=>{
    const d = document.createElement('div'); d.className='mem-card mem-card-inner mem-card-'+i; d.textContent='?'; d.dataset.val=v; d.style.padding='18px'; d.style.textAlign='center';
    d.addEventListener('click', ()=>{
      if(locked || d.classList.contains('revealed')) return;
      d.classList.add('revealed'); d.textContent = v;
      if(!first) first=d; else { second=d; locked=true;
        setTimeout(()=>{ if(first.dataset.val===second.dataset.val){ matched+=2; addMiniHistory('Pareja: '+first.dataset.val); storeMini({type:'memory',value:'match'}); } else { first.classList.remove('revealed'); first.textContent='?'; second.classList.remove('revealed'); second.textContent='?'; addMiniHistory('Pareja fallida'); } first=null; second=null; locked=false; if(matched===deck.length){ $('memMsg').textContent='¬°Completado!'; setMsg('Memoria completada','success'); } }, 600);
      }
    });
    grid.appendChild(d);
  });
}

/* breathing */
let breathInt=null;
function startBreath(){
  $('pageArea').innerHTML = `<div class="panel"><div style="font-weight:800">Gu√≠a de respiraci√≥n</div><div class="gameArea" style="margin-top:12px"><div id="breathCircle" style="width:120px;height:120px;border-radius:999px;background:linear-gradient(135deg, rgba(123,226,255,0.06), rgba(255,77,122,0.04));display:flex;align-items:center;justify-content:center;font-weight:700">Respira</div><div style="margin-top:12px"><button id="startB" class="btn">Iniciar</button><button id="stopB" class="btn alt">Detener</button></div></div></div>`;
  $('startB').addEventListener('click', ()=>{
    if(breathInt) clearInterval(breathInt);
    const c = $('breathCircle'); let s=0;
    breathInt = setInterval(()=>{ if(s===0){ c.style.transform='scale(1.4)'; } else if(s===1){ c.style.transform='scale(1.6)'; } else { c.style.transform='scale(1)'; } s=(s+1)%3; }, 4000);
    addMiniHistory('Respiraci√≥n iniciada'); setMsg('Empez√≥ respiraci√≥n','info');
  });
  $('stopB').addEventListener('click', ()=>{ if(breathInt) clearInterval(breathInt); setMsg('Respiraci√≥n detenida','info'); addMiniHistory('Respiraci√≥n detenida'); });
}

/* mini history and store */
function addMiniHistory(text){
  const box = $('miniHistory'); if(!box) return;
  const e = document.createElement('div'); e.style.padding='6px 0'; e.style.borderBottom='1px solid rgba(255,255,255,0.02)'; e.style.fontSize='13px';
  e.textContent = new Date().toLocaleTimeString() + ' ‚Äî ' + text; box.prepend(e);
}
function storeMini(obj){
  const u = localStorage.getItem('brisa_final_active') || ''; if(!u) return;
  const users = readStore(); const user = users.find(x=>x.user===u);
  user.history = user.history || []; user.history.push({ emotion: obj.type || 'Juego', detail: obj.value || '', date: new Date().toISOString(), game: obj.type });
  writeStore(users);
}

/* journal view (list) */
function startJournal(){
  if(!localStorage.getItem('brisa_final_active')){ setMsg('Inicia sesi√≥n para historial','error'); return; }
  const u = localStorage.getItem('brisa_final_active'); const users=readStore(); const user = users.find(x=>x.user===u);
  $('pageArea').innerHTML = `<div class="panel"><div style="font-weight:800">Historial de ${u}</div><div style="margin-top:12px;max-height:420px;overflow:auto">${(user.history||[]).slice().reverse().map(h=>`<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)"><strong>${h.emotion || h.detail || 'Registro'}</strong><div style="font-size:12px;color:var(--muted)">${new Date(h.date).toLocaleString()}</div></div>`).join('')||'<div class="small">Sin registros</div>'}</div></div>`;
}

/* invites view */
function startInvites(){
  if(!localStorage.getItem('brisa_final_active')){ setMsg('Inicia sesi√≥n para invites','error'); return; }
  const u = localStorage.getItem('brisa_final_active'); const users = readStore(); const user = users.find(x=>x.user===u);
  $('pageArea').innerHTML = `<div class="panel"><div style="font-weight:800">Invitaciones de ${u}</div><div style="margin-top:12px">${(user.invites||[]).slice().reverse().map(c=>`<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)">${c}</div>`).join('')||'<div class="small">No hay c√≥digos</div>'}</div></div>`;
}

/* nav buttons */
qAll('.sideBtn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    qAll('.sideBtn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
    const view = btn.dataset.view || 'home';
    $('pageTitle').textContent = view==='home' ? 'Inicio' : view==='games' ? 'Juegos' : view==='journal' ? 'Historial' : view==='invites' ? 'Invitaciones' : 'Brisa';
    $('pageSub').textContent = view==='home' ? 'Un espacio grande ‚Äî dise√±ado para ser bacano.' : '';
    if(view==='home'){ $('pageArea').innerHTML=''; }
    if(view==='games'){ startGameSelection(); }
    if(view==='journal'){ startJournal(); }
    if(view==='invites'){ startInvites(); }
  });
});

/* show games selection inside pageArea */
function startGameSelection(){
  $('pageArea').innerHTML = `<div class="panel"><div style="font-weight:800">Juegos</div><div style="margin-top:12px;display:flex;gap:8px"><button class="btn" onclick="startReaction()">Reacci√≥n</button><button class="btn" onclick="startMemory()">Memoria</button><button class="btn" onclick="startBreath()">Respiraci√≥n</button></div></div>`;
}

/* stats & UI refresh */
function refreshStats(){
  const users = readStore();
  $('statUsers').textContent = users.length;
  $('statRecords').textContent = users.reduce((s,u)=>s + (u.history ? u.history.length : 0), 0);
  $('statCodes').textContent = users.reduce((s,u)=>s + (u.invites ? u.invites.length : 0), 0);
  // recent
  const recent = [];
  users.forEach(u=> (u.history||[]).slice(-3).forEach(h=> recent.push({user:u.user, h})));
  recent.sort((a,b)=> new Date(b.h.date) - new Date(a.h.date));
  if(recent.length===0) $('recent').textContent='‚Äî ninguna ‚Äî';
  else $('recent').innerHTML = recent.slice(0,6).map(r=>`<div style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.02)"><strong>${r.user}</strong> ‚Ä¢ ${r.h.emotion || r.h.detail} <div style="font-size:12px;color:var(--muted)">${new Date(r.h.date).toLocaleString()}</div></div>`).join('');
}

/* session refresh */
function refreshSession(){
  const u = localStorage.getItem('brisa_final_active') || '';
  $('activeUser').textContent = u || '‚Äî';
  $('userInfoSmall').textContent = u || 'Invitado';
  $('createdAt').textContent = u ? `creado: ${ (readStore().find(x=>x.user===u)?.created ? new Date(readStore().find(x=>x.user===u).created).toLocaleDateString() : '') }` : '';
  $('logout').style.display = u ? 'inline-block' : 'none';
  renderCodes();
  refreshStats();
}
refreshSession();

/* helper: messages */
function setMsg(txt, type='info'){
  const el = $('miniFooter');
  el.textContent = txt;
  el.style.background = type==='error' ? 'rgba(120,20,20,0.7)' : type==='success' ? 'rgba(20,80,40,0.7)' : 'rgba(0,0,0,0.45)';
  setTimeout(()=> el.textContent = '¬© Brisa ‚Ä¢ Derechos reservados ‚Ä¢ @sa_mejia.e', 2600);
}

/* utility shuffle */
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }

/* store helper (writes and refreshes) */
function writeStoreAndRefresh(users){ localStorage.setItem(STORE, JSON.stringify(users)); refreshStats(); }

/* quick functions used earlier that reference global scope */
function startReaction(){ startReaction(); } // placeholder to avoid errors when called inline (we already have startReaction defined)
function startMemory(){ startMemory(); }
function startBreath(){ startBreath(); }

/* redeem prompt available globally */
window.redeemCode = function(){ const code = prompt('Ingresa c√≥digo:'); if(!code) return; const owner = readStore().find(u=> (u.invites||[]).includes(code.trim().toUpperCase())); if(owner) setMsg('C√≥digo v√°lido ‚Äî Bienvenido','success'); else setMsg('C√≥digo inv√°lido','error'); };

/* keyboard shortcuts example */
window.addEventListener('keydown', (e)=> {
  if(e.key==='g'){ $('genCode').click(); }
  if(e.key==='r'){ startReaction(); }
});

/* periodically refresh stats */
setInterval(()=>{ refreshStats(); refreshSession(); }, 2000);

</script>
</body>
</html>
