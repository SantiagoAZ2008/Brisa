<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Brisa ‚Äî Bienestar Emocional (funcional)</title>
<style>
  :root{
    --bg1:#07101a; --glass: rgba(255,255,255,0.03);
    --accent:#ff4d7a; --accent-2:#7be2ff; --muted:rgba(230,238,246,0.75);
    --success:#44d69e; --panel-bg: rgba(255,255,255,0.02);
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{
    font-family:Inter, system-ui, -apple-system, "Helvetica Neue", Arial;
    background:var(--bg1); color:#e6eef6; overflow:hidden;
  }

  /* canvas bg */
  canvas.bgLayer{ position:fixed; inset:0; width:100%; height:100%; z-index:0; display:block; }

  /* App layout */
  .app {
    position:relative; z-index:2;
    display:grid; grid-template-columns:260px 1fr 320px;
    gap:20px; padding:24px; height:100vh;
    align-items:start;
  }

  /* Remove heavy borders/lines: subtle glass panels */
  .panel {
    background: linear-gradient(180deg,var(--panel-bg), rgba(255,255,255,0.01));
    border-radius:14px; padding:16px; box-shadow: 0 10px 30px rgba(0,0,0,0.6);
    border: 1px solid rgba(255,255,255,0.02);
    backdrop-filter: blur(6px);
  }

  /* Sidebar */
  .sidebar .brand { display:flex; gap:10px; align-items:center; margin-bottom:10px }
  .logo { width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;
         background:linear-gradient(135deg,var(--accent),#9f6bff); color:white; box-shadow:0 6px 18px rgba(0,0,0,0.4); }
  .brand h1{font-size:16px}
  .brand p{font-size:12px;color:var(--muted)}

  .nav { display:flex; flex-direction:column; gap:8px; margin-top:12px }
  .nav button { background:transparent; color:inherit; border:none; padding:10px; text-align:left; border-radius:8px; cursor:pointer; transition:.12s }
  .nav button:hover{ transform:translateX(6px); background: rgba(255,255,255,0.02) }
  .nav button.active{ background: linear-gradient(90deg, rgba(255,77,122,0.08), rgba(123,226,255,0.03)); box-shadow: inset 0 0 30px rgba(255,255,255,0.01) }

  /* Main area */
  .main { height:calc(100vh - 48px); overflow:auto; padding:18px; }
  .header { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
  .title { font-size:20px; font-weight:700 }
  .subtitle { font-size:13px; color:var(--muted) }

  .grid { display:grid; grid-template-columns:repeat(2,1fr); gap:12px; }
  .wide { grid-column:1 / -1 }

  /* Clean controls */
  input, select { background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); color:inherit; padding:10px; border-radius:8px; }
  .btn { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; background:var(--accent); color:white; font-weight:700; }
  .btn.alt { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted) }

  /* games & big area */
  .big { display:flex; gap:12px; align-items:flex-start; }
  .leftCol { flex:1 }
  .rightCol { width:300px }

  /* memory cards */
  .mem-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px }
  .card { background: rgba(255,255,255,0.02); border-radius:10px; padding:18px; text-align:center; font-size:20px; cursor:pointer; user-select:none; transition:.12s }
  .card.revealed { transform:scale(1.02); background:linear-gradient(135deg, rgba(255,77,122,0.12), rgba(123,226,255,0.06)) }

  /* right column small */
  .stat { display:flex; justify-content:space-between; gap:12px; padding:10px; border-radius:8px; background: rgba(255,255,255,0.01) }

  /* footer mini */
  .miniFooter { position:fixed; left:50%; transform:translateX(-50%); bottom:12px; background: rgba(0,0,0,0.45); padding:8px 12px; border-radius:12px; font-size:13px; color:var(--muted); z-index:6; }

  /* hide ugly scrollbars but keep usability */
  ::-webkit-scrollbar{height:10px;width:10px;background:transparent}
  ::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.06);border-radius:10px}
  /* mobile */
  @media (max-width:1000px){ .app{ grid-template-columns:1fr; padding:12px } .rightCol{ width:100% } .grid{ grid-template-columns:1fr } .miniFooter{ left:12px; transform:none } }
</style>
</head>
<body>

<!-- Background -->
<canvas id="bg" class="bgLayer"></canvas>

<div class="app" id="app">
  <!-- SIDEBAR -->
  <aside class="panel sidebar">
    <div class="brand">
      <div class="logo">B+</div>
      <div>
        <h1>Brisa 2.0</h1>
        <p>Bienestar ‚Ä¢ Juegos ‚Ä¢ Comunidad</p>
      </div>
    </div>

    <nav class="nav" id="nav">
      <button data-view="home" class="active">Inicio</button>
      <button data-view="play">Juegos</button>
      <button data-view="journal">Historial</button>
      <button data-view="invites">Invitaciones</button>
      <button data-view="settings">Ajustes</button>
      <button data-view="about">Acerca</button>
    </nav>

    <div style="margin-top:12px;font-size:13px;color:var(--muted)">
      Usuario: <strong id="sidebarUser">Invitado</strong><br>
      <span id="sidebarStats">Sin sesi√≥n ‚Ä¢ 0 registros</span>
    </div>

    <div style="margin-top:14px">
      <a href="https://www.instagram.com/sa_mejia.e/" target="_blank" style="color:var(--accent);text-decoration:none">Instagram</a>
    </div>
  </aside>

  <!-- MAIN -->
  <main class="panel main">
    <div class="header">
      <div>
        <div class="title" id="pageTitle">Inicio</div>
        <div class="subtitle" id="pageSub">Un espacio grande ‚Äî dise√±ado para ser bacano.</div>
      </div>

      <div style="display:flex;gap:8px;align-items:center;">
        <label style="font-size:13px;color:var(--muted)">Sonido <input id="soundToggle" type="checkbox" checked /></label>
        <button id="logoutBtn" class="btn alt" style="display:none">Cerrar sesi√≥n</button>
      </div>
    </div>

    <div class="grid">
      <div class="panel">
        <div style="font-weight:700;margin-bottom:8px">Resumen r√°pido</div>
        <div style="display:flex;gap:8px;align-items:center">
          <div style="flex:1" class="stat"><div style="font-weight:800" id="statUsers">0</div><div class="small">Usuarios</div></div>
          <div style="flex:1" class="stat"><div style="font-weight:800" id="statRecords">0</div><div class="small">Registros</div></div>
        </div>
        <div style="margin-top:10px" class="stat"><div style="font-weight:800" id="statCodes">0</div><div class="small">Invitaciones</div></div>
      </div>

      <div class="panel">
        <div style="font-weight:700;margin-bottom:8px">Actividad reciente</div>
        <div id="recent" style="color:var(--muted);font-size:13px">‚Äî Ninguna actividad todav√≠a ‚Äî</div>
      </div>

      <!-- BIG interactive area -->
      <div class="panel wide big">
        <div class="leftCol">
          <div style="font-weight:700" id="welcomeTitle">¬°Bienvenido a Brisa!</div>
          <div class="subtitle" id="welcomeSub">Inicia sesi√≥n para usar todas las funciones.</div>

          <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
            <input id="inpUser" type="text" placeholder="Usuario (min 3)" />
            <input id="inpPass" type="password" placeholder="Contrase√±a (min 3)" />
            <button id="btnLogin" class="btn">Entrar</button>
            <button id="btnRegister" class="btn alt">Registrar</button>
          </div>

          <div style="margin-top:12px;display:flex;gap:8px">
            <button id="btnDemo" class="btn alt">Demo: llenar datos</button>
            <button id="btnExport" class="btn">Exportar datos</button>
          </div>

          <div style="margin-top:14px">
            <label class="small">Registrar emoci√≥n r√°pida</label>
            <div style="display:flex;gap:8px;margin-top:8px">
              <select id="quickEmotion" style="min-width:160px">
                <option>Feliz</option><option>Triste</option><option>Ansioso</option><option>Calmado</option><option>Motivado</option>
              </select>
              <button id="btnSaveEmotion" class="btn">Guardar</button>
            </div>
          </div>

        </div>

        <div class="rightCol">
          <div style="font-weight:700;margin-bottom:8px">Control r√°pido</div>
          <div style="display:flex;gap:8px;margin-bottom:10px">
            <button data-game="reaction" class="btn alt">Reacci√≥n</button>
            <button data-game="memory" class="btn alt">Memoria</button>
            <button data-game="breath" class="btn alt">Respiraci√≥n</button>
          </div>
          <div style="margin-top:8px">
            <div style="font-weight:700">Invitaciones</div>
            <div style="margin-top:8px;display:flex;gap:8px">
              <button id="btnGen" class="btn">Generar c√≥digo</button>
              <button id="btnShowCodes" class="btn alt">Ver c√≥digos</button>
            </div>
          </div>

          <div style="margin-top:12px">
            <div style="font-weight:700">Preferencias</div>
            <div style="margin-top:8px">
              <label class="small"><input type="checkbox" id="ambientToggle" checked/> M√∫sica ambiental</label><br>
              <label class="small"><input type="checkbox" id="fancyBG" checked/> Fondo din√°mico</label>
            </div>
          </div>

        </div>
      </div>

      <div class="panel">
        <div style="font-weight:700">Distribuci√≥n de emociones</div>
        <div id="bars" style="margin-top:10px;color:var(--muted)">‚Äî sin datos ‚Äî</div>
      </div>

      <div class="panel">
        <div style="font-weight:700">Tus c√≥digos</div>
        <div id="codesBox" style="margin-top:10px;color:var(--muted)">‚Äî ninguno ‚Äî</div>
      </div>
    </div>
  </main>

  <!-- RIGHT -->
  <aside class="panel right">
    <div style="font-weight:700">Panel r√°pido</div>
    <div style="margin-top:10px" id="miniRoot">Selecciona un juego para empezar</div>
    <div style="margin-top:12px">
      <div style="font-weight:700">Sesi√≥n</div>
      <div style="margin-top:6px">Usuario: <strong id="activeUser">‚Äî</strong></div>
      <div class="small" id="actCreated">‚Äî</div>
    </div>

    <div style="margin-top:12px">
      <div style="font-weight:700">Historial reciente</div>
      <div id="miniHistory" style="margin-top:8px;color:var(--muted);max-height:220px;overflow:auto"></div>
    </div>
  </aside>
</div>

<div class="miniFooter" id="miniFooter">¬© Brisa ‚Ä¢ Derechos reservados ‚Ä¢ <span style="color:var(--accent)">@sa_mejia.e</span></div>

<script>
/* ---------------------------
   Lightweight single-file app
   --------------------------- */

/* Helpers */
const $ = id => document.getElementById(id);
const qsa = s => document.querySelectorAll(s);
const storeKey = 'brisa_v2_store';

function readStore(){ return JSON.parse(localStorage.getItem(storeKey) || '[]'); }
function writeStore(data){ localStorage.setItem(storeKey, JSON.stringify(data)); updateStats(); }

function currentUser(){ return localStorage.getItem('brisa_v2_active') || ''; }
function setActive(u){ if(u) localStorage.setItem('brisa_v2_active', u); else localStorage.removeItem('brisa_v2_active'); refreshSession(); }

/* init UI references */
const navBtns = qsa('#nav button');
navBtns.forEach(b => b.addEventListener('click', ()=>{ navBtns.forEach(x=>x.classList.remove('active')); b.classList.add('active'); changePage(b.dataset.view); }));

$('logoutBtn').addEventListener('click', ()=>{ setActive(''); setMsg('Sesion cerrada','info'); });

/* basic messages */
function setMsg(t, type='info'){
  const el = $('miniFooter');
  el.textContent = t;
  el.style.background = type==='error' ? 'rgba(120,20,20,0.7)' : type==='success' ? 'rgba(20,80,40,0.7)' : 'rgba(0,0,0,0.45)';
  setTimeout(()=> el.textContent = '¬© Brisa ‚Ä¢ Derechos reservados ‚Ä¢ @sa_mejia.e', 2500);
}

/* Events: login/register */
$('btnLogin').addEventListener('click', ()=>{
  const u=$('inpUser').value.trim(), p=$('inpPass').value.trim();
  if(u.length<3||p.length<3){ setMsg('Usuario y contrase√±a de 3+ caracteres','error'); return; }
  const users = readStore();
  const found = users.find(x=>x.user===u && x.pass===p);
  if(found){ setActive(u); setMsg('Bienvenido '+u,'success'); $('inpUser').value=''; $('inpPass').value=''; } else setMsg('Usuario/contrase√±a incorrectos','error');
});

$('btnRegister').addEventListener('click', ()=>{
  const u=$('inpUser').value.trim(), p=$('inpPass').value.trim();
  if(u.length<3||p.length<3){ setMsg('Usuario y contrase√±a de 3+ caracteres','error'); return; }
  const users = readStore();
  if(users.find(x=>x.user===u)){ setMsg('Usuario ya existe','error'); return; }
  users.push({ user:u, pass:p, created:new Date().toISOString(), history:[], invites:[] });
  writeStore(users); setActive(u); setMsg('Usuario creado y sesi√≥n iniciada','success'); $('inpUser').value=''; $('inpPass').value='';
});

$('btnDemo').addEventListener('click', ()=>{
  const users = readStore();
  if(users.length===0){
    users.push({user:'alice',pass:'1234',created:new Date().toISOString(),history:[{emotion:'Feliz',date:new Date().toISOString()}],invites:['ABC123']});
    users.push({user:'santiago',pass:'abc',created:new Date().toISOString(),history:[{emotion:'Ansioso',date:new Date().toISOString()}],invites:[]});
    writeStore(users); setMsg('Demo cargada','success');
  } else setMsg('Ya hay datos','info');
});

/* export */
$('btnExport').addEventListener('click', ()=>{
  const data = JSON.stringify(readStore(), null, 2);
  const blob = new Blob([data], {type:'application/json'}); const url=URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='brisa_data.json'; a.click(); URL.revokeObjectURL(url);
  setMsg('Snapshot descargado','info');
});

/* quick save emotion */
$('btnSaveEmotion').addEventListener('click', ()=>{
  const emo = $('quickEmotion').value;
  const u = currentUser();
  if(!u){ setMsg('Inicia sesi√≥n para guardar emociones','error'); return; }
  const users = readStore(); const user = users.find(x=>x.user===u);
  user.history = user.history || []; user.history.push({ emotion: emo, date: new Date().toISOString() });
  writeStore(users); setMsg('Emoci√≥n guardada','success'); refreshSession();
});

/* generate code */
$('btnGen').addEventListener('click', ()=>{
  const u = currentUser(); if(!u){ setMsg('Inicia sesi√≥n para generar c√≥digos','error'); return; }
  const users = readStore(); const user = users.find(x=>x.user===u);
  const code = Math.random().toString(36).substring(2,9).toUpperCase();
  user.invites = user.invites || []; user.invites.push(code); writeStore(users);
  setMsg('C√≥digo generado: '+code,'success'); renderCodes();
});

/* show codes */
$('btnShowCodes').addEventListener('click', renderCodes);

/* view change */
function changePage(view){
  $('pageTitle').textContent = {home:'Inicio', play:'Juegos', journal:'Historial', invites:'Invitaciones', settings:'Ajustes', about:'Acerca'}[view] || 'Inicio';
  // focus different places - simply update big/mini panels
  if(view==='play'){ openGameSelection(); }
  if(view==='journal'){ openJournalView(); }
  if(view==='invites'){ openInvitesView(); }
  if(view==='settings'){ openSettings(); }
  if(view==='about'){ openAbout(); }
}

/* initial view */
changePage('home');

/* render stats & recent */
function updateStats(){
  const users = readStore();
  $('statUsers').textContent = users.length;
  $('statRecords').textContent = users.reduce((s,u)=>s + (u.history?u.history.length:0), 0);
  $('statCodes').textContent = users.reduce((s,u)=>s + (u.invites?u.invites.length:0), 0);

  // recent activity:
  const recent = [];
  users.forEach(u=> (u.history||[]).slice(-3).forEach(h=> recent.push({user:u.user, h})));
  recent.sort((a,b)=> new Date(b.h.date) - new Date(a.h.date));
  if(recent.length===0) $('recent').innerHTML = '‚Äî Ninguna actividad todav√≠a ‚Äî';
  else $('recent').innerHTML = recent.slice(0,6).map(r=>`<div style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.02)"><strong>${r.user}</strong> ‚Ä¢ ${r.h.emotion} <div style="font-size:12px;color:var(--muted)">${new Date(r.h.date).toLocaleString()}</div></div>`).join('');
  renderBars();
}

/* render emotion bars */
function renderBars(){
  const users = readStore();
  const counts = {};
  users.forEach(u=> (u.history||[]).forEach(h=> counts[h.emotion] = (counts[h.emotion]||0)+1 ));
  const container = $('bars'); container.innerHTML = '';
  const keys = Object.keys(counts); if(keys.length===0){ container.textContent='‚Äî sin datos ‚Äî'; return; }
  const max = Math.max(...Object.values(counts));
  keys.forEach(k=>{
    const v = counts[k]; const pct = Math.round(v/max*100);
    const el = document.createElement('div'); el.style.display='flex'; el.style.alignItems='center'; el.style.gap='8px';
    el.innerHTML = `<div style="width:30%">${k}</div><div style="flex:1;background:rgba(255,255,255,0.02);height:12px;border-radius:6px;overflow:hidden"><div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--accent),var(--accent-2))"></div></div><div style="width:36px;text-align:right">${v}</div>`;
    container.appendChild(el);
  });
}

/* render codes list */
function renderCodes(){
  const u = currentUser();
  if(!u){ $('codesBox').textContent='Inicia sesi√≥n para ver tus c√≥digos'; return; }
  const users = readStore(); const user = users.find(x=>x.user===u);
  $('codesBox').innerHTML = (user.invites||[]).length ? (user.invites||[]).slice().reverse().map(c=>`<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)"><strong>${c}</strong></div>`).join('') : '‚Äî ninguno ‚Äî';
}

/* refresh session display */
function refreshSession(){
  const u = currentUser();
  $('sidebarUser').textContent = u || 'Invitado';
  $('activeUser').textContent = u || '‚Äî';
  if(u){
    $('logoutBtn').style.display = 'inline-block';
    const users = readStore(); const user = users.find(x=>x.user===u);
    $('actCreated').textContent = user ? `creado: ${new Date(user.created).toLocaleDateString()}` : '';
  } else {
    $('logoutBtn').style.display = 'none';
    $('actCreated').textContent = '';
  }
  $('sidebarStats').textContent = (u ? 'Sesi√≥n activa' : 'Sin sesi√≥n') + ' ‚Ä¢ ' + (readStore().find(x=>x.user===u)?.history?.length || 0) + ' registros';
  updateStats();
  renderCodes();
}
refreshSession();

/* -------------------------
   Games: reaction, memory, breathing
   ------------------------- */
function openGameSelection(){
  $('miniRoot').innerHTML = `<div style="font-weight:700">Elige un minijuego</div><div style="margin-top:8px;display:flex;gap:8px"><button class="btn" onclick="startReaction()">Reacci√≥n</button><button class="btn" onclick="startMemory()">Memoria</button><button class="btn" onclick="startBreath()">Respiraci√≥n</button></div>`;
}

/* Reaction */
function startReaction(){
  $('miniRoot').innerHTML = `<div style="font-weight:700">Reacci√≥n</div><div style="margin-top:10px"><button id="reBtn" class="btn" style="padding:16px 32px">Preparar</button></div><div id="reRes" style="margin-top:8px;color:var(--muted)"></div>`;
  const btn = $('reBtn'), res = $('reRes');
  let start=null, timeoutId=null;
  btn.addEventListener('click', ()=>{
    btn.disabled=true; btn.textContent='Espera...'; btn.style.background='#333';
    timeoutId = setTimeout(()=>{ start = performance.now(); btn.disabled=false; btn.textContent='¬°Presiona!'; btn.style.background= 'var(--success)'; }, Math.random()*1800 + 800);
  });
  btn.addEventListener('click', ()=>{
    if(!start){ // was a false click handled above when disabled reset
      if(timeoutId) clearTimeout(timeoutId);
      btn.textContent='Preparar'; btn.style.background='var(--accent)';
      res.textContent='Falso inicio';
      addMiniHistory('Falso inicio (Reacci√≥n)');
      return;
    }
    const elapsed = Math.round(performance.now() - start);
    res.textContent = 'Tiempo: ' + elapsed + ' ms';
    addMiniHistory('Reacci√≥n: ' + elapsed + ' ms');
    storeMiniResult({type:'reaction', value:elapsed, date:new Date().toISOString()});
    start=null; btn.textContent='Preparar'; btn.style.background='var(--accent)';
  }, { once:false });
}

/* Memory */
function startMemory(){
  const colors = ['üçÄ','üå∏','üåô','üî•','üíß','‚≠ê','üçé','‚ö°'];
  const deck = shuffle([...colors,...colors]);
  let first=null, second=null, locked=false, matched=0;
  const gridHtml = deck.map((v,i)=>`<div class="card" data-i="${i}" data-val="${v}">?</div>`).join('');
  $('miniRoot').innerHTML = `<div style="font-weight:700">Memoria</div><div style="margin-top:10px" class="mem-grid">${gridHtml}</div><div id="memMsg" style="margin-top:8px;color:var(--muted)"></div>`;
  const cards = document.querySelectorAll('.mem-grid .card');
  cards.forEach(c=> c.addEventListener('click', ()=>{
    if(locked || c.classList.contains('revealed')) return;
    c.classList.add('revealed'); c.textContent = c.dataset.val;
    if(!first) first = c;
    else { second = c; locked=true;
      setTimeout(()=>{
        if(first.dataset.val === second.dataset.val){ matched+=2; first.classList.add('matched'); second.classList.add('matched'); addMiniHistory('Pareja encontrada '+first.dataset.val); storeMiniResult({type:'memory', value:'match', date:new Date().toISOString()}); }
        else { first.classList.remove('revealed'); first.textContent='?'; second.classList.remove('revealed'); second.textContent='?'; addMiniHistory('Pareja fallida'); }
        first=null; second=null; locked=false;
        if(matched === deck.length) { $('memMsg').textContent='¬°Completado!'; setMsg('Memoria completada','success'); }
      },600);
    }
  }));
}

/* Breath (simple) */
let breathInterval=null;
function startBreath(){
  $('miniRoot').innerHTML = `<div style="font-weight:700">Respiraci√≥n</div><div style="margin-top:12px"><div id="breathCircle" style="width:120px;height:120px;border-radius:999px;background:linear-gradient(135deg, rgba(123,226,255,0.06), rgba(255,77,122,0.04));display:flex;align-items:center;justify-content:center;font-weight:700;margin:auto">Respira</div></div><div style="margin-top:12px;display:flex;gap:8px"><button id="startB" class="btn">Iniciar</button><button id="stopB" class="btn alt">Detener</button></div>`;
  $('startB').addEventListener('click', ()=>{
    if(breathInterval) clearInterval(breathInterval);
    const circle = $('breathCircle'); const hint = $('miniRoot');
    let s=0;
    breathInterval = setInterval(()=>{
      if(s===0){ circle.style.transform='scale(1.4)'; } else if(s===1){ circle.style.transform='scale(1.6)'; } else { circle.style.transform='scale(1)'; }
      s=(s+1)%3;
    },4000);
    addMiniHistory('Breathing started');
  });
  $('stopB').addEventListener('click', ()=>{ if(breathInterval) clearInterval(breathInterval); setMsg('Respiraci√≥n detenida','info'); addMiniHistory('Breathing stopped'); });
}

/* Mini history helper */
function addMiniHistory(txt){
  const el = document.createElement('div'); el.style.padding='6px 0'; el.style.borderBottom='1px solid rgba(255,255,255,0.02)'; el.style.fontSize='13px';
  el.textContent = new Date().toLocaleTimeString() + ' ‚Äî ' + txt;
  const box = $('miniHistory'); box.prepend(el);
}

/* store mini result in user's history */
function storeMiniResult(obj){
  const u = currentUser(); if(!u) return;
  const users = readStore(); const user = users.find(x=>x.user===u);
  user.history = user.history || []; user.history.push({ emotion: obj.type || 'Juego', detail: obj.value, date: obj.date || new Date().toISOString() });
  writeStore(users);
}

/* Journal view */
function openJournalView(){
  const user = currentUser(); if(!user){ setMsg('Inicia sesi√≥n para ver historial','error'); return; }
  const users = readStore(); const u = users.find(x=>x.user===user);
  const leftHtml = `<div style="font-weight:700">Historial de ${user}</div><div style="margin-top:10px;max-height:380px;overflow:auto">${(u.history||[]).slice().reverse().map(h=>`<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)"><strong>${h.emotion||h.detail||'Registro'}</strong><div style="font-size:12px;color:var(--muted)">${new Date(h.date).toLocaleString()}</div></div>`).join('') || '<div class="small">Sin registros</div>'}</div>`;
  const panel = $('bigPanel'); // not present; we'll update miniRoot instead
  $('miniRoot').innerHTML = leftHtml;
}

/* Invites view */
function openInvitesView(){
  const u = currentUser(); if(!u){ setMsg('Inicia sesi√≥n para administrar invitaciones','error'); return; }
  const users = readStore(); const user = users.find(x=>x.user===u);
  $('miniRoot').innerHTML = `<div style="font-weight:700">Invitaciones de ${u}</div><div style="margin-top:10px">${(user.invites||[]).slice().reverse().map(c=>`<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)">${c}</div>`).join('') || '<div class="small">No hay c√≥digos</div>'}</div>`;
}

/* settings/about */
function openSettings(){ $('miniRoot').innerHTML = `<div style="font-weight:700">Ajustes</div><div style="margin-top:8px" class="small">Preferencias locales (temporal)</div>`; }
function openAbout(){ $('miniRoot').innerHTML = `<div style="font-weight:700">Acerca de Brisa</div><div style="margin-top:8px" class="small">Versi√≥n funcional. Autor: Santiago N√∫√±ez</div>`; }

/* shuffle */
function shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]] } return arr; }

/* invite redeem (global simple prompt) */
function redeemCodePrompt(){
  const code = prompt('Ingresa el c√≥digo a canjear:').trim().toUpperCase();
  if(!code) return;
  const users = readStore();
  const owner = users.find(u => (u.invites||[]).includes(code));
  if(!owner){ setMsg('C√≥digo inv√°lido','error'); return; }
  setMsg('C√≥digo v√°lido - bienvenido','success');
}

/* render codes on right and stats */
function renderCodes(){
  const all = readStore().flatMap(u => (u.invites||[]).map(c=>({c,by:u.user})));
  $('codesBox').innerHTML = all.length ? all.map(x=>`<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)">${x.c} ‚Äî ${x.by}</div>`).join('') : '‚Äî ninguno ‚Äî';
}

/* initialize: wired control buttons for quick game buttons */
document.querySelectorAll('[data-game]').forEach(b => b.addEventListener('click', (ev)=>{
  const g = b.dataset.game;
  if(g==='reaction') startReaction();
  if(g==='memory') startMemory();
  if(g==='breath') startBreath();
}));

/* quick keyboard shortcuts */
window.addEventListener('keydown', e=>{
  if(e.key==='g'){ $('btnGen').click(); setMsg('Generar c√≥digo (G)','info'); }
  if(e.key==='r'){ startReaction(); setMsg('Abrir Reacci√≥n (R)','info'); }
});

/* render initial stats */
updateStats();

/* wire codes show */
$('btnShowCodes').addEventListener('click', ()=>{
  const all = readStore().flatMap(u => (u.invites||[]).map(c=> `${c} ‚Äî ${u.user}`));
  alert(all.length ? all.join('\\n') : 'No hay c√≥digos');
});

/* redeem example: attach to some button if wanted */
window.redeemCodePrompt = redeemCodePrompt;

/* ---------- Background: damasco-ish dynamic (canvas) ---------- */
const canvas = $('bg'); const ctx = canvas.getContext('2d');
function resizeCanvas(){ canvas.width = innerWidth * devicePixelRatio; canvas.height = innerHeight * devicePixelRatio; canvas.style.width = innerWidth + 'px'; canvas.style.height = innerHeight + 'px'; ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0); }
resizeCanvas(); window.addEventListener('resize', resizeCanvas);

const blobs = [];
for(let i=0;i<18;i++){
  blobs.push({ x: Math.random()*innerWidth, y: Math.random()*innerHeight, r: 80 + Math.random()*220, vx:(Math.random()-0.5)*0.3, vy:(Math.random()-0.5)*0.3, color: ['#23182a','#7a263f','#b43b5a','#12202a'][i%4] });
}
let t0 = performance.now();
(function draw(now){
  const t = (now - t0) * 0.0006;
  ctx.clearRect(0,0,innerWidth,innerHeight);
  // layer blobs
  blobs.forEach((b,idx)=>{
    b.x += b.vx * Math.cos(t*(0.4+idx*0.02));
    b.y += b.vy * Math.sin(t*(0.3+idx*0.02));
    const g = ctx.createRadialGradient(b.x,b.y,b.r*0.05,b.x,b.y,b.r);
    g.addColorStop(0, hexRgba(b.color, 0.18));
    g.addColorStop(1, hexRgba(b.color, 0.03));
    ctx.beginPath(); ctx.fillStyle = g; ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
  });
  // soft overlay particles
  for(let i=0;i<600;i++){
    ctx.fillStyle = `rgba(255,255,255,${(Math.random()-0.96)*0.02})`;
    ctx.fillRect(Math.random()*innerWidth, Math.random()*innerHeight, 1,1);
  }
  requestAnimationFrame(draw);
})(performance.now());

function hexRgba(hex,a){ const c = hex.replace('#',''); const n = parseInt(c,16); const r=(n>>16)&255,g=(n>>8)&255,b=n&255; return `rgba(${r},${g},${b},${a})`; }

/* make sure UI stays updated every 2s */
setInterval(()=>{ updateStats(); refreshSession(); }, 2000);

</script>
</body>
</html>
