<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Brisa V4 ‚Äî Nebula UX</title>
<style>
  /* ---------- Reset & base ---------- */
  :root{
    --bg-1:#05060a;
    --panel: rgba(255,255,255,0.03);
    --muted: rgba(230,238,246,0.65);
    --accent: #ff4d7a;
    --accent2: #7be2ff;
    --glass: rgba(255,255,255,0.04);
    --success: #44d69e;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;background:var(--bg-1);font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;color:#eaf0f8}
  a{color:inherit}
  button{font-family:inherit}

  /* ---------- Background canvas ---------- */
  canvas#bg { position:fixed; inset:0; width:100%; height:100%; z-index:0; display:block; }

  /* ---------- Layout ---------- */
  .app {
    position:relative;
    z-index:2;
    display:grid;
    grid-template-columns:88px 1fr 320px;
    gap:18px;
    height:100vh;
    padding:22px;
    align-items:start;
  }

  /* ---------- Sidebar (left) ---------- */
  .sidebar {
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:14px;
    padding:14px 8px;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:12px;
    box-shadow: 0 12px 40px rgba(0,0,0,0.6);
    border:1px solid rgba(255,255,255,0.02);
  }
  .logo {
    width:56px;height:56px;border-radius:12px;
    display:flex;align-items:center;justify-content:center;font-weight:900;
    background:linear-gradient(135deg,var(--accent),#9f6bff); color:white; font-size:18px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.6);
  }
  .side-btn {
    width:100%; display:flex; flex-direction:column; align-items:center; gap:6px; padding:8px;
    border-radius:10px; cursor:pointer; color:var(--muted); background:transparent; border:none;
    transition:all .14s ease;
  }
  .side-btn:hover { transform:translateX(6px); background: rgba(255,255,255,0.02); color:#fff }
  .side-btn.active { background: linear-gradient(90deg, rgba(255,77,122,0.08), rgba(123,226,255,0.03)); color:#fff }

  .iconLabel { font-size:11px; color:var(--muted) }

  /* ---------- Main (center) ---------- */
  .main {
    overflow:auto;
    padding:14px;
    border-radius:14px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border:1px solid rgba(255,255,255,0.02);
    box-shadow: 0 12px 40px rgba(0,0,0,0.6);
    min-height: calc(100vh - 44px);
  }

  .topbar {
    display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:14px;
  }
  .title { font-weight:800; font-size:20px }
  .subtitle { color:var(--muted); font-size:13px }

  .content {
    display:grid;
    grid-template-columns: 1fr;
    gap:12px;
  }

  .panel {
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
    border-radius:12px; padding:14px; border:1px solid rgba(255,255,255,0.02);
  }

  /* ---------- Right column ---------- */
  .right {
    padding:14px; border-radius:14px; background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    box-shadow: 0 12px 40px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.02); min-height: calc(100vh - 44px); overflow:auto;
  }
  .right h3 { margin-bottom:8px }
  .small { font-size:13px; color:var(--muted) }

  /* ---------- Controls ---------- */
  input, select { width:100%; padding:10px 12px; border-radius:8px; background: rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); color:inherit; }
  .btn { padding:10px 14px; border-radius:10px; border:none; cursor:pointer; background:var(--accent); color:white; font-weight:700; }
  .btn.alt { background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted) }

  /* ---------- Games ---------- */
  .game-area { min-height:200px; display:flex; align-items:center; justify-content:center; flex-direction:column; gap:10px; }

  .mem-grid { display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:12px; }
  .mem-card { background: rgba(255,255,255,0.02); padding:18px; text-align:center; font-size:22px; border-radius:10px; cursor:pointer; user-select:none; transition:transform .12s ease; }
  .mem-card.revealed { transform:scale(1.04); background: linear-gradient(135deg, rgba(255,77,122,0.12), rgba(123,226,255,0.06)); }

  /* ---------- Footer small ---------- */
  .footer { position:fixed; left:50%; transform:translateX(-50%); bottom:12px; background:rgba(0,0,0,0.45); padding:8px 12px; border-radius:12px; font-size:13px; color:var(--muted); z-index:4; }

  /* ---------- Modal (login/register) ---------- */
  .modal-bg { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:flex; align-items:center; justify-content:center; z-index:30; }
  .modal { width:420px; max-width:92%; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); padding:18px; border-radius:12px; box-shadow:0 30px 90px rgba(0,0,0,0.7); border:1px solid rgba(255,255,255,0.02) }
  .modal h2 { margin-bottom:8px; }
  .link-like { color:var(--accent); cursor:pointer; text-decoration:underline; display:inline-block; margin-top:8px; }

  /* responsive */
  @media (max-width:1000px){
    .app { grid-template-columns:72px 1fr; padding:12px; }
    .right { display:none }
    .mem-grid { grid-template-columns:repeat(2,1fr); }
    .title{font-size:18px}
  }
</style>
</head>
<body>

<canvas id="bg"></canvas>

<div class="app">

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">Br</div>

    <button class="side-btn active" data-view="home" title="Inicio"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 10.5L12 4l9 6.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg><div class="iconLabel">Inicio</div></button>

    <button class="side-btn" data-view="games" title="Juegos"><svg width="20" height="20" viewBox="0 0 24 24"><path d="M6 12h12" stroke="currentColor" stroke-width="1.5"/></svg><div class="iconLabel">Juegos</div></button>

    <button class="side-btn" data-view="emotions" title="Emociones"><svg width="20" height="20" viewBox="0 0 24 24"><path d="M7 11h10" stroke="currentColor" stroke-width="1.5"/></svg><div class="iconLabel">Emociones</div></button>

    <button class="side-btn" data-view="users" title="Usuarios"><svg width="20" height="20" viewBox="0 0 24 24"><circle cx="12" cy="8" r="3" stroke="currentColor" stroke-width="1.5"/></svg><div class="iconLabel">Usuarios</div></button>

    <button class="side-btn" data-view="invites" title="Invitaciones"><svg width="20" height="20" viewBox="0 0 24 24"><path d="M3 8h18" stroke="currentColor" stroke-width="1.5"/></svg><div class="iconLabel">Invites</div></button>

    <div style="flex:1"></div>

    <button class="side-btn" id="profileBtn" title="Perfil"><svg width="20" height="20" viewBox="0 0 24 24"><circle cx="12" cy="8" r="3" stroke="currentColor" stroke-width="1.5"/></svg><div class="iconLabel">Perfil</div></button>

  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <div>
        <div class="title" id="pageTitle">Inicio</div>
        <div class="subtitle" id="pageSub">Bienvenido a Brisa ‚Äî Nebula UX. Inicia sesi√≥n para usar todas las funciones.</div>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <label class="small">Sonido
          <input id="soundToggle" type="checkbox" checked style="margin-left:6px"/>
        </label>
        <button class="btn alt" id="btnLogout" style="display:none">Cerrar sesi√≥n</button>
      </div>
    </div>

    <div class="content">
      <!-- Quick panels -->
      <div class="panel" id="homePanel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800;font-size:16px">Resumen</div>
            <div class="small">Estad√≠sticas r√°pidas y actividad</div>
          </div>
          <div class="small" id="userBadge">Invitado</div>
        </div>

        <div style="display:flex;gap:12px;margin-top:12px">
          <div style="flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01)"><div style="font-size:22px;font-weight:800" id="statUsers">0</div><div class="small">Usuarios</div></div>
          <div style="flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01)"><div style="font-size:22px;font-weight:800" id="statRecords">0</div><div class="small">Registros</div></div>
          <div style="flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.01)"><div style="font-size:22px;font-weight:800" id="statCodes">0</div><div class="small">Invitaciones</div></div>
        </div>

        <div style="margin-top:14px">
          <div style="font-weight:700">Actividad reciente</div>
          <div id="recent" class="small" style="margin-top:8px">‚Äî ninguna ‚Äî</div>
        </div>
      </div>

      <!-- Dynamic page area -->
      <div class="panel" id="pageArea" style="min-height:240px">
        <div style="display:flex;gap:12px;align-items:center">
          <input id="quickUser" placeholder="Usuario" style="width:220px"/>
          <input id="quickPass" placeholder="Contrase√±a" type="password" style="width:220px"/>
          <button class="btn" id="quickLogin">Entrar</button>
          <button class="btn alt" id="quickRegister">Registrar</button>
          <button class="btn alt" id="demoLoad">Cargar demo</button>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
          <select id="quickEmotion" style="width:160px"><option>Feliz</option><option>Triste</option><option>Ansioso</option><option>Calmado</option><option>Motivado</option></select>
          <button class="btn" id="saveQuickEmotion">Guardar emoci√≥n</button>
          <button class="btn" id="exportData">Exportar</button>
        </div>

        <div id="infoArea" style="margin-top:16px;color:var(--muted);font-size:14px">
          Usa la barra lateral para navegar. El login es obligatorio para registrar emociones, generar c√≥digos o jugar.
        </div>
      </div>

    </div>
  </main>

  <!-- Right -->
  <aside class="right">
    <h3>Mini-juegos</h3>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn alt game-start" data-game="reaction">Reacci√≥n</button>
      <button class="btn alt game-start" data-game="memory">Memoria</button>
      <button class="btn alt game-start" data-game="breath">Respiraci√≥n</button>
    </div>

    <div style="margin-top:14px">
      <h3>Invitaciones</h3>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="genInvite">Generar</button>
        <button class="btn alt" id="showInvites">Ver</button>
      </div>
      <div id="invList" class="small" style="margin-top:8px">‚Äî ninguno ‚Äî</div>
    </div>

    <div style="margin-top:14px">
      <h3>Sesi√≥n</h3>
      <div style="margin-top:6px">Activo: <strong id="activeUser">‚Äî</strong></div>
      <div id="createdInfo" class="small" style="margin-top:6px">‚Äî</div>
    </div>

    <div style="margin-top:14px">
      <h3>Enlaces</h3>
      <div class="small" style="margin-top:6px"><a href="https://www.instagram.com/sa_mejia.e/" target="_blank" style="color:var(--accent)">Instagram</a></div>
    </div>
  </aside>
</div>

<div class="footer">¬© Brisa ‚Äî Todos los derechos reservados ‚Äî <span style="color:var(--accent)">@sa_mejia.e</span></div>

<!-- LOGIN / REGISTER MODAL (mandatory) -->
<div id="modalWrap" class="modal-bg" style="display:none;">
  <div class="modal">
    <h2 id="modalH">Iniciar sesi√≥n</h2>
    <input id="modalUser" placeholder="Usuario"/>
    <input id="modalPass" placeholder="Contrase√±a" type="password" style="margin-top:8px"/>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn" id="modalPrimary">Entrar</button>
      <button class="btn alt" id="modalAlt">Registrar</button>
    </div>
    <div id="modalMsg" class="small" style="margin-top:10px;color:var(--muted)"></div>
    <div style="margin-top:10px"><span id="modalToggle" class="link-like">¬øNo tienes cuenta? Reg√≠strate</span></div>
  </div>
</div>

<script>
/* ===============================
   BRISA V4 ‚Äî Nebula UX (complete)
   - All-new interface from scratch
   - Canvas background (camouflage + neon)
   - Mandatory modal login/register
   - Sidebar navigation + SPA behavior
   - LocalStorage persistence
   - Games: Reaction & Memory + Breathing guide
   - Invitations, export, stats
   =============================== */

/* ---------- Helpers ---------- */
const $ = id => document.getElementById(id);
const $$ = sel => document.querySelectorAll(sel);
const STORE_KEY = 'brisa_v4_store';
const ACTIVE_KEY = 'brisa_v4_active';

function readStore(){ return JSON.parse(localStorage.getItem(STORE_KEY) || '[]'); }
function writeStore(data){ localStorage.setItem(STORE_KEY, JSON.stringify(data)); refreshStats(); }
function currentUser(){ return localStorage.getItem(ACTIVE_KEY) || ''; }
function setActive(user){ if(user) localStorage.setItem(ACTIVE_KEY, user); else localStorage.removeItem(ACTIVE_KEY); refreshSession(); }

/* ---------- Canvas BG (camouflage + neon flow) ---------- */
const canvas = $('bg'), ctx = canvas.getContext('2d');
function resizeCanvas(){
  canvas.width = innerWidth * devicePixelRatio;
  canvas.height = innerHeight * devicePixelRatio;
  canvas.style.width = innerWidth + 'px';
  canvas.style.height = innerHeight + 'px';
  ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0);
}
resizeCanvas(); window.addEventListener('resize', resizeCanvas);

// create moving blobs
const palette = ['#37202b','#7a263f','#b43b5a','#12202a', '#1a2430'];
const blobs = [];
for(let i=0;i<18;i++){
  blobs.push({
    x: Math.random()*innerWidth,
    y: Math.random()*innerHeight,
    r: 70 + Math.random()*200,
    vx: (Math.random()-0.5)*0.25,
    vy: (Math.random()-0.5)*0.25,
    c: palette[i % palette.length]
  });
}
let t0 = performance.now();
function drawFrame(now){
  const t = (now - t0) * 0.0006;
  ctx.clearRect(0,0,innerWidth,innerHeight);

  // layer 1: large radial blobs (camouflage)
  blobs.forEach((b,i)=>{
    b.x += b.vx * Math.cos(t*(0.4 + i*0.02));
    b.y += b.vy * Math.sin(t*(0.3 + i*0.02));
    const g = ctx.createRadialGradient(b.x, b.y, b.r*0.05, b.x, b.y, b.r);
    g.addColorStop(0, hexRgba(b.c, 0.16));
    g.addColorStop(1, hexRgba(b.c, 0.02));
    ctx.beginPath(); ctx.fillStyle = g; ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill();
  });

  // layer 2: neon ribbons
  for(let i=0;i<20;i++){
    const cx = (Math.sin(t*0.7 + i)*0.5 + 0.5) * innerWidth;
    const cy = (Math.cos(t*0.6 + i*0.6)*0.5 + 0.5) * innerHeight;
    const r = 220 + Math.sin(t*0.2 + i)*80;
    const g2 = ctx.createRadialGradient(cx,cy,r*0.1,cx,cy,r);
    g2.addColorStop(0, `rgba(123,226,255,${0.03 + (i%2)*0.02})`);
    g2.addColorStop(1, `rgba(255,77,122,0.012)`);
    ctx.beginPath(); ctx.fillStyle = g2; ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
  }

  // grain
  for(let i=0;i<400;i++){
    ctx.fillStyle = `rgba(255,255,255,${(Math.random()-0.98)*0.02})`;
    ctx.fillRect(Math.random()*innerWidth, Math.random()*innerHeight, 1, 1);
  }

  requestAnimationFrame(drawFrame);
}
requestAnimationFrame(drawFrame);
function hexRgba(hex,a){ const c = hex.replace('#',''); const n = parseInt(c,16); const r=(n>>16)&255,g=(n>>8)&255,b=n&255; return `rgba(${r},${g},${b},${a})`; }

/* ---------- Modal: mandatory login/register ---------- */
const modalWrap = $('modalWrap'), modalH = $('modalH'), modalUser = $('modalUser'), modalPass = $('modalPass'), modalMsg = $('modalMsg');
const modalPrimary = $('modalPrimary'), modalAlt = $('modalAlt'), modalToggle = $('modalToggle');

function showModal(mode='login'){
  modalWrap.style.display = 'flex';
  if(mode==='login'){ modalH.textContent='Iniciar sesi√≥n'; modalPrimary.textContent='Entrar'; modalAlt.textContent='Registrar'; modalToggle.textContent='¬øNo tienes cuenta? Reg√≠strate'; }
  else { modalH.textContent='Registrar cuenta'; modalPrimary.textContent='Registrar'; modalAlt.textContent='Volver'; modalToggle.textContent='¬øYa tienes cuenta? Iniciar sesi√≥n'; }
  modalMsg.textContent='';
  modalUser.value=''; modalPass.value='';
}
function hideModal(){ modalWrap.style.display = 'none'; }

modalToggle.addEventListener('click', ()=>{
  if(modalH.textContent.includes('Iniciar')) showModal('register'); else showModal('login');
});
modalAlt.addEventListener('click', ()=>{
  if(modalH.textContent.includes('Iniciar')) showModal('register'); else showModal('login');
});

/* primary button handles both login & register based on modal title */
modalPrimary.addEventListener('click', ()=>{
  const u = modalUser.value.trim(), p = modalPass.value.trim();
  if(u.length<3 || p.length<3){ modalMsg.textContent = 'Usuario y contrase√±a m√≠nimo 3 caracteres'; return; }
  const users = readStore();
  if(modalH.textContent.includes('Iniciar')){
    const found = users.find(x=>x.user===u && x.pass===p);
    if(found){ setActive(u); modalMsg.textContent='Bienvenido '+u; setTimeout(hideModal, 600); } else modalMsg.textContent='Credenciales inv√°lidas';
  } else {
    if(users.find(x=>x.user===u)){ modalMsg.textContent='Usuario ya existe'; return; }
    users.push({ user:u, pass:p, created: new Date().toISOString(), history:[], invites:[] });
    writeStore(users); setActive(u); modalMsg.textContent='Registrado ‚úì'; setTimeout(hideModal, 600);
  }
});

/* If no active user, show modal on load */
if(!currentUser()) showModal('login');

/* ---------- Nav (sidebar) ---------- */
$$('.side-btn').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    $$(' .side-btn').forEach(x=>x.classList.remove('active')); // small safeguard
    $$('.side-btn').forEach(x => x.classList.remove('active'));
    btn.classList.add('active');
    const view = btn.dataset.view || 'home';
    navigateTo(view);
  });
});

/* fallback helper to set active by querySelectorAll */
function setActiveSidebar(view){
  $$('.side-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.view === view);
  });
}

/* ---------- Navigation / SPA ---------- */
function navigateTo(view){
  setActiveSidebar(view);
  $('pageTitle').textContent = view === 'home' ? 'Inicio' :
                               view === 'games' ? 'Juegos' :
                               view === 'emotions' ? 'Emociones' :
                               view === 'users' ? 'Usuarios' :
                               view === 'invites' ? 'Invitaciones' : 'Brisa';
  $('pageSub').textContent = view === 'home' ? 'Un espacio grande ‚Äî dise√±ado para ser bacano.' : '';
  // render main section content
  if(view==='home'){ renderHome(); }
  if(view==='games'){ renderGames(); }
  if(view==='emotions'){ renderEmotions(); }
  if(view==='users'){ renderUsers(); }
  if(view==='invites'){ renderInvitesView(); }
}

/* ---------- Renderers ---------- */
function renderHome(){
  const page = $('pageArea');
  page.innerHTML = `
    <div style="display:flex;gap:12px;align-items:center">
      <input id="quickU" placeholder="Usuario" style="width:220px"/>
      <input id="quickP" placeholder="Contrase√±a" type="password" style="width:220px"/>
      <button class="btn" id="quickLoginBtn">Entrar</button>
      <button class="btn alt" id="quickRegBtn">Registrar</button>
      <button class="btn alt" id="demoLoadBtn">Demo</button>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;align-items:center">
      <select id="emoQuick"><option>Feliz</option><option>Triste</option><option>Ansioso</option><option>Calmado</option><option>Motivado</option></select>
      <button class="btn" id="saveQuick">Guardar emoci√≥n</button>
      <button class="btn" id="exportBtn">Exportar</button>
      <button class="btn alt" id="redeemBtn">Canjear</button>
    </div>
    <div style="margin-top:12px;color:var(--muted)" id="homeInfo">Panel r√°pido</div>
  `;

  // wire quick controls
  $('quickLoginBtn').addEventListener('click', ()=>{
    const u = $('quickU').value.trim(), p = $('quickP').value.trim();
    if(u.length<3||p.length<3){ setMsg('Usuario/contrase√±a 3+','error'); return; }
    const users = readStore(); const f = users.find(x=>x.user===u && x.pass===p);
    if(f){ setActive(u); setMsg('Sesi√≥n iniciada','success'); $('quickU').value=''; $('quickP').value=''; } else setMsg('Credenciales inv√°lidas','error');
  });
  $('quickRegBtn').addEventListener('click', ()=>{
    const u = $('quickU').value.trim(), p = $('quickP').value.trim();
    if(u.length<3||p.length<3){ setMsg('Usuario/contrase√±a 3+','error'); return; }
    const users = readStore();
    if(users.find(x=>x.user===u)){ setMsg('Usuario ya existe','error'); return; }
    users.push({ user:u, pass:p, created: new Date().toISOString(), history:[], invites:[] }); writeStore(users); setActive(u); setMsg('Registrado y conectado','success'); $('quickU').value=''; $('quickP').value='';
  });
  $('demoLoadBtn').addEventListener('click', loadDemo);
  $('saveQuick').addEventListener('click', ()=>{
    const emo = $('emoQuick').value;
    const u = currentUser();
    if(!u){ setMsg('Inicia sesi√≥n para guardar','error'); return; }
    const users = readStore(); const user = users.find(x=>x.user===u);
    user.history = user.history || []; user.history.push({ emotion: emo, date: new Date().toISOString() }); writeStore(users); setMsg('Emoci√≥n guardada','success'); refreshStats();
  });
  $('exportBtn').addEventListener('click', exportData);
  $('redeemBtn').addEventListener('click', redeemPrompt);
}

function renderGames(){
  const page = $('pageArea');
  page.innerHTML = `
    <div style="display:flex;gap:8px">
      <button class="btn" id="startReact">Reacci√≥n</button>
      <button class="btn" id="startMemory">Memoria</button>
      <button class="btn" id="startBreath">Respiraci√≥n</button>
    </div>
    <div id="gameArea" style="margin-top:12px"></div>
  `;
  $('startReact').addEventListener('click', startReactionView);
  $('startMemory').addEventListener('click', startMemoryView);
  $('startBreath').addEventListener('click', startBreathView);
}

function renderEmotions(){
  const users = readStore();
  const counts = {};
  users.forEach(u => (u.history||[]).forEach(h => counts[h.emotion] = (counts[h.emotion]||0) + 1));
  const page = $('pageArea'); page.innerHTML = `<div style="font-weight:800">Distribuci√≥n de emociones</div><div id="emoBars" style="margin-top:12px"></div>`;
  const cont = $('emoBars');
  const keys = Object.keys(counts);
  if(keys.length===0){ cont.innerHTML = '<div class="small">Sin datos</div>'; return; }
  const max = Math.max(...Object.values(counts));
  cont.innerHTML = '';
  keys.forEach(k=>{
    const v = counts[k]; const pct = Math.round(v/max*100);
    const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='8px'; row.style.marginBottom='8px';
    row.innerHTML = `<div style="width:120px">${k}</div><div style="flex:1;background:rgba(255,255,255,0.02);height:12px;border-radius:6px;overflow:hidden"><div style="height:100%;width:${pct}%;background:linear-gradient(90deg,var(--accent),var(--accent2))"></div></div><div style="width:44px;text-align:right">${v}</div>`;
    cont.appendChild(row);
  });
}

function renderUsers(){
  const users = readStore();
  const page = $('pageArea'); page.innerHTML = `<div style="font-weight:800">Usuarios registrados (${users.length})</div><div id="userList" style="margin-top:12px"></div>`;
  const ul = $('userList');
  if(users.length===0){ ul.innerHTML='<div class="small">No hay usuarios</div>'; return; }
  ul.innerHTML = users.map(u => `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)"><strong>${u.user}</strong> ‚Ä¢ ${u.history?.length||0} registros <div class="small">${new Date(u.created).toLocaleString()}</div></div>`).join('');
}

function renderInvitesView(){
  const users = readStore();
  const page = $('pageArea');
  page.innerHTML = `<div style="display:flex;gap:8px"><button class="btn" id="genCodeBtn">Generar c√≥digo</button><button class="btn alt" id="exportCodes">Exportar mis c√≥digos</button></div><div id="myCodes" style="margin-top:12px" class="small"></div>`;
  $('genCodeBtn').addEventListener('click', ()=>{ generateInvite(); });
  $('exportCodes').addEventListener('click', exportMyCodes);
  showMyCodes();
}

/* ---------- Quick functions ---------- */
function loadDemo(){
  const users = readStore();
  if(users.length>0){ setMsg('Ya existen datos','info'); return; }
  users.push({ user:'alice', pass:'123', created:new Date().toISOString(), history:[{ emotion:'Feliz', date: new Date().toISOString() }], invites:['ABC123'] });
  users.push({ user:'santiago', pass:'abc', created:new Date().toISOString(), history:[{ emotion:'Ansioso', date: new Date().toISOString() }], invites:[] });
  writeStore(users); setMsg('Demo cargada','success'); refreshStats();
}

function exportData(){
  const data = JSON.stringify(readStore(), null, 2);
  const blob = new Blob([data], { type:'application/json' }); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'brisa_v4_export.json'; a.click(); URL.revokeObjectURL(url);
  setMsg('Exportado','info');
}

function redeemPrompt(){
  const code = prompt('Ingrese c√≥digo a canjear:');
  if(!code) return;
  const users = readStore();
  const owner = users.find(u => (u.invites || []).includes(code.trim().toUpperCase()));
  if(owner) setMsg('C√≥digo v√°lido ‚Äî Bienvenido', 'success'); else setMsg('C√≥digo inv√°lido', 'error');
}

/* ---------- Invites ---------- */
function generateInvite(){
  const u = currentUser();
  if(!u){ setMsg('Inicia sesi√≥n para generar c√≥digos','error'); return; }
  const users = readStore(); const user = users.find(x=>x.user===u);
  const code = Math.random().toString(36).substring(2,9).toUpperCase();
  user.invites = user.invites || []; user.invites.push(code); writeStore(users); setMsg('C√≥digo: ' + code, 'success'); showMyCodes();
}
function showMyCodes(){
  const u = currentUser();
  const users = readStore();
  const all = users.flatMap(x => (x.invites||[]).map(c => ({c, by:x.user})));
  $('invList').innerHTML = all.length ? all.map(x=>`<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)"><strong>${x.c}</strong> ‚Ä¢ ${x.by}</div>`).join('') : '‚Äî ninguno ‚Äî';
}
function exportMyCodes(){
  const u = currentUser();
  if(!u){ setMsg('Inicia sesi√≥n primero','error'); return; }
  const users = readStore(); const me = users.find(x=>x.user===u);
  const blob = new Blob([JSON.stringify(me.invites || [], null, 2)], { type:'application/json' }); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'invites_'+u+'.json'; a.click(); URL.revokeObjectURL(url);
  setMsg('C√≥digos exportados','info');
}

/* ---------- Games (Reaction & Memory & Breathing) ---------- */
/* Reaction view */
function startReactionView(){
  const ga = $('gameArea'); if(!ga) return;
  ga.innerHTML = `<div class="game-area"><div style="font-weight:800">Reacci√≥n</div><button class="btn" id="reactStart" style="padding:18px 30px">Preparar</button><div id="reactResult" class="small"></div></div>`;
  const btn = $('reactStart'), res = $('reactResult');
  let start = null, timeoutId = null;
  btn.addEventListener('click', ()=>{
    if(!currentUser()){ setMsg('Inicia sesi√≥n para jugar','error'); return; }
    btn.disabled = true; btn.textContent = 'Espera...'; btn.style.background = '#333';
    timeoutId = setTimeout(()=>{ start = performance.now(); btn.disabled=false; btn.textContent='¬°Presiona!'; btn.style.background='var(--success)'; }, Math.random()*1800 + 700);
  });
  btn.addEventListener('click', ()=>{
    if(!start){ if(timeoutId) clearTimeout(timeoutId); btn.textContent='Preparar'; btn.style.background='var(--accent)'; res.textContent='Falso inicio'; addMini('Falso inicio (reacci√≥n)'); return; }
    const elapsed = Math.round(performance.now() - start);
    res.textContent = 'Tiempo: ' + elapsed + ' ms';
    addMini('Reacci√≥n: ' + elapsed + ' ms');
    storeResult({ type:'reaction', value: elapsed });
    start = null; btn.textContent='Preparar'; btn.style.background='var(--accent)';
  });
}

/* Memory view */
function startMemoryView(){
  if(!currentUser()){ setMsg('Inicia sesi√≥n para jugar','error'); return; }
  const pool = ['üçÄ','üå∏','üåô','üî•','üíß','‚≠ê','üçé','‚ö°'];
  const deck = shuffle([...pool, ...pool]);
  let first = null, second = null, locked = false, matched = 0;
  const ga = $('gameArea'); if(!ga) return;
  ga.innerHTML = `<div class="game-area"><div style="font-weight:800">Memoria</div><div class="mem-grid" id="memGrid"></div><div id="memMsg" class="small" style="margin-top:8px"></div></div>`;
  const grid = $('memGrid');
  deck.forEach((val, idx) => {
    const card = document.createElement('div'); card.className = 'mem-card'; card.textContent = '?'; card.dataset.val = val;
    card.addEventListener('click', ()=>{
      if(locked || card.classList.contains('revealed')) return;
      card.classList.add('revealed'); card.textContent = val;
      if(!first) first = card; else { second = card; locked = true;
        setTimeout(()=> {
          if(first.dataset.val === second.dataset.val){ matched += 2; addMini('Pareja: '+first.dataset.val); storeResult({ type:'memory', value:'match' }); }
          else { first.classList.remove('revealed'); first.textContent='?'; second.classList.remove('revealed'); second.textContent='?'; addMini('Pareja fallida'); }
          first = null; second = null; locked = false;
          if(matched === deck.length){ $('memMsg').textContent = '¬°Completado!'; setMsg('Memoria completada','success'); }
        }, 600);
      }
    });
    grid.appendChild(card);
  });
}

/* Breathing view */
let breathInterval = null;
function startBreathView(){
  const ga = $('gameArea'); if(!ga) return;
  ga.innerHTML = `<div class="game-area"><div style="font-weight:800">Gu√≠a de respiraci√≥n</div><div id="breathCircle" style="width:120px;height:120px;border-radius:999px;background:linear-gradient(135deg, rgba(123,226,255,0.06), rgba(255,77,122,0.04));display:flex;align-items:center;justify-content:center">Respira</div><div style="margin-top:10px"><button class="btn" id="startBreathBtn">Iniciar</button><button class="btn alt" id="stopBreathBtn">Detener</button></div></div>`;
  $('startBreathBtn').addEventListener('click', ()=>{
    if(breathInterval) clearInterval(breathInterval);
    const c = $('breathCircle'); let s=0;
    breathInterval = setInterval(()=>{ if(s===0) c.style.transform='scale(1.4)'; else if(s===1) c.style.transform='scale(1.6)'; else c.style.transform='scale(1)'; s=(s+1)%3; }, 4000);
    addMini('Breathing started'); setMsg('Gu√≠a de respiraci√≥n iniciada','info');
  });
  $('stopBreathBtn').addEventListener('click', ()=>{ if(breathInterval) clearInterval(breathInterval); setMsg('Respiraci√≥n detenida','info'); addMini('Breathing stopped'); });
}

/* ---------- Helpers: store, stats, session ---------- */
function storeResult(obj){
  const u = currentUser(); if(!u) return;
  const users = readStore(); const user = users.find(x=>x.user===u);
  user.history = user.history || []; user.history.push({ emotion: obj.type || 'Juego', detail: obj.value || '', date: new Date().toISOString(), game: obj.type });
  writeStore(users);
}

function addMini(msg){
  const box = $('recent'); if(!box) return;
  const e = document.createElement('div'); e.style.padding='6px 0'; e.style.borderBottom='1px solid rgba(255,255,255,0.02)'; e.style.fontSize='13px';
  e.textContent = new Date().toLocaleTimeString() + ' ‚Äî ' + msg; box.prepend(e);
}

function refreshStats(){
  const users = readStore();
  $('statUsers').textContent = users.length;
  $('statRecords').textContent = users.reduce((s,u)=>s + (u.history?u.history.length:0), 0);
  $('statCodes').textContent = users.reduce((s,u)=>s + (u.invites?u.invites.length:0), 0);
  // recent activities
  const recent = [];
  users.forEach(u => (u.history||[]).slice(-3).forEach(h => recent.push({ user:u.user, h })));
  recent.sort((a,b)=> new Date(b.h.date) - new Date(a.h.date));
  if(recent.length===0) $('recent').textContent = '‚Äî ninguna ‚Äî';
  else $('recent').innerHTML = recent.slice(0,6).map(r => `<div style="padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.02)"><strong>${r.user}</strong> ‚Ä¢ ${r.h.emotion || r.h.detail} <div style="font-size:12px;color:var(--muted)">${new Date(r.h.date).toLocaleString()}</div></div>`).join('');
}

function refreshSession(){
  const u = currentUser();
  $('activeUser').textContent = u || '‚Äî';
  $('userBadge').textContent = u || 'Invitado';
  $('createdInfo').textContent = u ? `creado: ${ new Date((readStore().find(x=>x.user===u) || {}).created).toLocaleDateString() }` : '';
  $('btnLogout').style.display = u ? 'inline-block' : 'none';
  showMyCodes();
  refreshStats();
}

/* ---------- Utility ---------- */
function setMsg(txt, type='info'){
  const el = $('.footer') || document.querySelector('.footer');
  if(el) el.textContent = txt;
  // color feedback via background
  const color = type === 'error' ? 'rgba(120,20,20,0.7)' : type === 'success' ? 'rgba(20,80,40,0.7)' : 'rgba(0,0,0,0.45)';
  if(el) el.style.background = color;
  setTimeout(()=>{ if(el) { el.textContent = '¬© Brisa ‚Äî Todos los derechos reservados ‚Äî @sa_mejia.e'; el.style.background = 'rgba(0,0,0,0.45)'; } }, 2500);
}

function shuffle(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a }

/* ---------- Quick wiring: sidebar game buttons & global ---------- */
$$('.game-start').forEach(b => b.addEventListener('click', ()=> startGame(b.dataset.game)));
function startGame(name){ if(!currentUser()){ setMsg('Inicia sesi√≥n para jugar','error'); showModal('login'); return; } if(name==='reaction') { navigateTo('games'); setTimeout(startReactionView, 80) } if(name==='memory'){ navigateTo('games'); setTimeout(startMemoryView, 80) } if(name==='breath'){ navigateTo('games'); setTimeout(startBreathView, 80) } }

/* ---------- Quick page load & actions ---------- */
$('quickLogin').addEventListener('click', ()=>{
  const u = $('quickUser').value.trim(), p = $('quickPass').value.trim();
  if(u.length<3||p.length<3){ setMsg('Usuario/contrase√±a 3+','error'); return; }
  const users = readStore(); const found = users.find(x=>x.user===u && x.pass===p);
  if(found){ setActive(u); setMsg('Bienvenido '+u,'success'); $('quickUser').value=''; $('quickPass').value=''; } else setMsg('Credenciales inv√°lidas','error');
});
$('quickRegister').addEventListener('click', ()=>{
  const u = $('quickUser').value.trim(), p = $('quickPass').value.trim();
  if(u.length<3||p.length<3){ setMsg('Usuario/contrase√±a 3+','error'); return; }
  const users = readStore(); if(users.find(x=>x.user===u)){ setMsg('Usuario ya existe','error'); return; }
  users.push({ user:u, pass:p, created:new Date().toISOString(), history:[], invites:[] }); writeStore(users); setActive(u); setMsg('Registrado y conectado','success'); $('quickUser').value=''; $('quickPass').value='';
});
$('demoLoad').addEventListener('click', loadDemo);

/* quick export and redeem on main page area buttons are handled inside renderHome or renderHome controls */

/* gen invite/show invites on right */
$('genInvite').addEventListener('click', generateInvite);
$('showInvites').addEventListener('click', ()=>{ alert( readStore().flatMap(u => (u.invites||[]).map(c => `${c} ‚Äî ${u.user}`)).join('\\n') || 'No hay c√≥digos' ); });

/* logout */
$('btnLogout').addEventListener('click', ()=>{ setActive(''); setMsg('Sesi√≥n cerrada','info'); showModal('login'); });

/* keyboard shortcuts */
window.addEventListener('keydown', (e)=>{ if(e.key==='g'){ generateInvite(); setMsg('C√≥digo generado (G)','info') } if(e.key==='r'){ startReactionView(); } });

/* ---------- Initial render ---------- */
navigateTo('home');
refreshStats();
refreshSession();

/* Helper: show my codes in right panel */
function showMyCodes(){
  const all = readStore().flatMap(u => (u.invites||[]).map(c => ({ c, by: u.user })));
  $('invList').innerHTML = all.length ? all.map(x=>`<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)"><strong>${x.c}</strong> ‚Ä¢ ${x.by}</div>`).join('') : '‚Äî ninguno ‚Äî';
}

/* generate invite (alternate) */
function generateInvite(){
  const u = currentUser(); if(!u){ setMsg('Inicia sesi√≥n para generar','error'); return; }
  const users = readStore(); const user = users.find(x=>x.user===u);
  const code = Math.random().toString(36).substring(2,9).toUpperCase();
  user.invites = user.invites || []; user.invites.push(code); writeStore(users); setMsg('C√≥digo generado: ' + code, 'success'); showMyCodes();
}

/* export my codes */
function exportMyCodes(){
  const u = currentUser(); if(!u){ setMsg('Inicia sesi√≥n','error'); return; }
  const users = readStore(); const user = users.find(x=>x.user===u);
  const blob = new Blob([JSON.stringify(user.invites||[], null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'invites_'+u+'.json'; a.click(); URL.revokeObjectURL(url); setMsg('C√≥digos exportados','info');
}

/* export helper */
function exportData(){
  const blob = new Blob([JSON.stringify(readStore(), null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'brisa_v4_data.json'; a.click(); URL.revokeObjectURL(url); setMsg('Exportado','info');
}

/* tiny redeem via window.redeemCode (global) */
window.redeemCode = function(){ redeemPrompt(); };

/* EOF */
</script>

</body>
</html>
