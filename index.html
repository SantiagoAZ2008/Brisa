<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Brisa 1.0 (2025) — Nuevo</title>
<style>
/* ===========================================
   BRISA 1.0 (2025) — ÚNICO ARCHIVO: HTML+CSS+JS
   - Inicio info / autor
   - Juegos mejorados + memoria espacial
   - Registro de emociones con notas & escala
   - Usuarios + datos editables + invites
   - Login/Registro modal con blur animado
   - Invite codes persistentes en localStorage (ver nota)
   ===========================================*/

/* --- Reset & base --- */
:root{
  --bg-1:#05060a; --card: rgba(255,255,255,0.03);
  --muted: rgba(230,238,246,0.65);
  --accent: #ff4d7a; --accent2:#7be2ff;
  --success:#44d69e; --danger:#f87171;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;background:var(--bg-1);color:#eaf0f8;-webkit-font-smoothing:antialiased;}
a{color:var(--accent)}
button{font-family:inherit}

/* --- background canvas full screen --- */
canvas#bg { position:fixed; inset:0; width:100%; height:100%; z-index:0; display:block; }

/* --- blur overlay container (applied while modal visible) --- */
#pageWrap { position:relative; z-index:2; width:100%; height:100%; transition:filter .6s ease, opacity .4s ease; }

/* --- layout --- */
.app { display:grid; grid-template-columns:88px 1fr 340px; gap:18px; padding:22px; min-height:100vh; align-items:start; position:relative; z-index:2; }

.sidebar {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:12px; padding:12px; display:flex; flex-direction:column; gap:12px; align-items:center;
  box-shadow: 0 12px 40px rgba(0,0,0,0.7); border:1px solid rgba(255,255,255,0.02);
}
.logo { width:62px;height:62px;border-radius:12px; display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,var(--accent),#9f6bff); font-weight:900; color:white; font-size:18px; box-shadow:0 8px 22px rgba(0,0,0,0.6); }

.sideBtn { width:100%; display:flex; flex-direction:column; align-items:center; gap:6px; padding:10px; background:transparent; color:var(--muted); border-radius:10px; border:none; cursor:pointer; transition: all .12s ease; }
.sideBtn:hover{ transform: translateX(6px); color: white; background: rgba(255,255,255,0.02); }
.sideBtn.active{ background: linear-gradient(90deg, rgba(255,77,122,0.08), rgba(123,226,255,0.03)); color:white; }

/* --- main --- */
.main {
  border-radius:12px; padding:18px; min-height: calc(100vh - 44px);
  background: linear-gradient(180deg, rgba(255,255,255,0.015), rgba(255,255,255,0.005));
  border:1px solid rgba(255,255,255,0.02);
  box-shadow: 0 12px 40px rgba(0,0,0,0.7);
  overflow:auto;
}
.topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; margin-bottom:12px; }
.title { font-size:20px; font-weight:800; }
.subtitle { color:var(--muted); font-size:13px; }

/* page area */
.page { display:grid; grid-template-columns: 1fr; gap:12px; }
.card {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:12px; padding:14px; border:1px solid rgba(255,255,255,0.02);
}

/* --- right column --- */
.right {
  border-radius:12px; padding:14px; height: calc(100vh - 44px); overflow:auto;
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  box-shadow: 0 12px 40px rgba(0,0,0,0.7); border:1px solid rgba(255,255,255,0.02);
}

/* buttons and inputs */
input, select, textarea { background: rgba(255,255,255,0.02); color:inherit; border:1px solid rgba(255,255,255,0.03); padding:10px 12px; border-radius:8px; width:100%; }
textarea{ min-height:84px; resize:vertical; }
.btn { padding:10px 12px; border-radius:10px; border:none; cursor:pointer; background:var(--accent); color:white; font-weight:700; }
.btn.alt{ background:transparent; border:1px solid rgba(255,255,255,0.04); color:var(--muted); }

/* small components */
.small{ font-size:13px; color:var(--muted); }
.statGrid{ display:flex; gap:8px; margin-top:10px; }
.statBox{ flex:1; background: rgba(255,255,255,0.01); padding:10px; border-radius:8px; text-align:center; }

/* emotions table */
.table{ width:100%; border-collapse:collapse; margin-top:10px; }
.table th, .table td{ text-align:left; padding:8px; border-bottom:1px solid rgba(255,255,255,0.03); font-size:13px; color: #eaf0f8; }

/* memory grid new style */
.grid-4{ display:grid; grid-template-columns: repeat(4, 1fr); gap:8px; }
.tile{ background: rgba(255,255,255,0.02); border-radius:10px; padding:18px; text-align:center; cursor:pointer; transition:transform .12s ease; user-select:none; font-size:20px; }
.tile.revealed{ transform:scale(1.04); background: linear-gradient(135deg, rgba(255,77,122,0.12), rgba(123,226,255,0.06)); }

/* toast */
#toast{ position:fixed; right:18px; bottom:18px; background:rgba(0,0,0,0.6); color:var(--muted); padding:10px 12px; border-radius:10px; z-index:50; border:1px solid rgba(255,255,255,0.03); }

/* modal (login/register) with blur effect */
.modalWrap{ position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:60; }
.modal { width:420px; max-width:94%; padding:18px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); box-shadow:0 30px 80px rgba(0,0,0,0.7); border:1px solid rgba(255,255,255,0.02); }
.modal h2{ color:var(--accent); margin-bottom:8px; }
.modal .row{ display:flex; gap:8px; margin-top:8px; }
.modal .muted{ color:var(--muted); margin-top:8px; font-size:13px; }
.blurOn { filter: blur(8px) brightness(.8); transition: filter .6s ease; }

/* responsive */
@media (max-width:1100px){
  .app{ grid-template-columns:72px 1fr; padding:12px; }
  .right{ display:none; }
  .grid-4{ grid-template-columns: repeat(2,1fr); }
}
</style>
</head>
<body>

<!-- BACKGROUND CANVAS -->
<canvas id="bg"></canvas>

<!-- PAGE CONTENT (will blur while modal is open) -->
<div id="pageWrap">
  <div class="app">
    <!-- SIDEBAR -->
    <aside class="sidebar" aria-hidden="false">
      <div class="logo">Br1</div>
      <button class="sideBtn active" data-view="inicio" title="Inicio"><svg width="20" height="20" viewBox="0 0 24 24" fill="none"><path d="M3 10.5L12 4l9 6.5" stroke="currentColor" stroke-width="1.5"/></svg><div class="small">Inicio</div></button>
      <button class="sideBtn" data-view="juegos" title="Juegos"><svg width="20" height="20" viewBox="0 0 24 24"><path d="M6 12h12" stroke="currentColor" stroke-width="1.5"/></svg><div class="small">Juegos</div></button>
      <button class="sideBtn" data-view="emociones" title="Registro de emociones"><svg width="20" height="20"><path d="M7 11h10" stroke="currentColor" stroke-width="1.5"/></svg><div class="small">Emociones</div></button>
      <button class="sideBtn" data-view="usuarios" title="Usuarios"><svg width="20" height="20"><circle cx="12" cy="8" r="3" stroke="currentColor" stroke-width="1.5"/></svg><div class="small">Usuarios</div></button>
      <button class="sideBtn" data-view="perfil" title="Perfil"><svg width="20" height="20"><path d="M3 8h18" stroke="currentColor" stroke-width="1.5"/></svg><div class="small">Perfil</div></button>
      <div style="flex:1"></div>
      <div style="font-size:12px;color:var(--muted);text-align:center;padding:6px">© Brisa 1.0 — 2025<br><a href="https://www.instagram.com/sa_mejia.e/" target="_blank" style="color:var(--accent);text-decoration:none">@sa_mejia.e</a></div>
    </aside>

    <!-- MAIN -->
    <main class="main" role="main">
      <div class="topbar">
        <div>
          <div class="title" id="pageTitle">Inicio</div>
          <div class="subtitle" id="pageSub">Información, propósito y autor — Brisa 1.0 (2025)</div>
        </div>
        <div style="display:flex;gap:10px;align-items:center">
          <label class="small">Sonido <input id="soundToggle" type="checkbox" checked style="margin-left:8px" /></label>
          <button class="btn alt" id="logoutBtn" style="display:none">Cerrar sesión</button>
        </div>
      </div>

      <div class="page" id="pageContent">
        <!-- INICIO (info) -->
        <section id="inicio" class="card">
          <h3>¿Qué es Brisa 1.0?</h3>
          <p class="small" style="margin-top:8px">
            Brisa 1.0 es una aplicación de bienestar emocional y entrenamiento mental diseñada como un espacio privado para registrar tu estado emocional, practicar mini-juegos de agilidad mental y registrar notas diarias sobre cómo te sientes.
          </p>

          <div style="display:flex;gap:12px;margin-top:12px;align-items:stretch">
            <div style="flex:1">
              <div class="card">
                <strong>Propósito</strong>
                <p class="small" style="margin-top:6px">Ayudarte a tomar registro de tus emociones y practicar ejercicios mentales cortos que mejoren tu atención y memoria. Guarda tus entradas y revisa tu progreso.</p>
              </div>
            </div>

            <div style="width:320px">
              <div class="card">
                <strong>Autor</strong>
                <p class="small" style="margin-top:6px">Santiago Núñez Mejía</p>
                <a href="https://www.instagram.com/sa_mejia.e/" target="_blank" class="small" style="color:var(--accent)">Instagram • @sa_mejia.e</a>
                <div class="small" style="margin-top:8px">Versión: Brisa 1.0 — 2025</div>
              </div>

              <div class="card" style="margin-top:12px">
                <strong>Cómo usar</strong>
                <ol class="small" style="margin-top:8px;padding-left:16px;line-height:1.4">
                  <li>Regístrate o inicia sesión (obligatorio para guardar datos).</li>
                  <li>Registra tu emoción en "Emociones". Puedes añadir una nota y una puntuación (1-10).</li>
                  <li>Juega los mini-juegos para registrar tus tiempos y rendimiento.</li>
                  <li>Genera códigos de invitación para invitar a otros (quedará registrado quién invitó a quién).</li>
                </ol>
              </div>
            </div>
          </div>
        </section>

        <!-- placeholder for dynamic page content (juegos, emociones, usuarios, perfil) -->
        <section id="dynamicArea" class="card" style="display:none"></section>

      </div>
    </main>

    <!-- RIGHT -->
    <aside class="right">
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Mini-juegos</strong><div class="small">Ejercita tu mente</div></div>
          <div class="small" id="miniStat">—</div>
        </div>

        <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
          <button class="btn alt" id="btnReaction">Reacción</button>
          <button class="btn alt" id="btnSpatial">Habilidad (memoria espacial)</button>
          <button class="btn alt" id="btnBreath">Respiración</button>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Invitaciones</strong>
        <div style="margin-top:8px;display:flex;gap:8px">
          <button class="btn" id="genInvite">Generar</button>
          <button class="btn alt" id="showInv">Ver</button>
        </div>
        <div id="invBox" class="small" style="margin-top:8px">— ninguna —</div>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Sesion</strong>
        <div style="margin-top:6px">Usuario: <strong id="activeUser">—</strong></div>
        <div id="createdInfo" class="small" style="margin-top:6px">—</div>
        <div style="margin-top:8px">
          <button class="btn alt" id="exportAll">Exportar datos</button>
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- TOAST -->
<div id="toast" style="display:none"></div>

<!-- LOGIN / REGISTER MODAL (with blur on pageWrap while open) -->
<div id="modal" class="modalWrap" style="display:flex; z-index:80">
  <div class="modal" role="dialog" aria-modal="true">
    <h2 id="modalTitle">Iniciar sesión</h2>

    <label class="small">Usuario</label>
    <input id="mUser" placeholder="usuario (min 3)">

    <label class="small" style="margin-top:8px">Contraseña</label>
    <input id="mPass" type="password" placeholder="contraseña (min 3)">

    <div class="row" style="margin-top:12px">
      <button class="btn" id="modalPrimary">Entrar</button>
      <button class="btn alt" id="modalSecondary">Registrar</button>
    </div>

    <div style="margin-top:10px" class="muted" id="modalMsg">Debes iniciar sesión o registrarte para guardar datos.</div>

    <div style="margin-top:12px">
      <div class="small">Código de invitación (opcional)</div>
      <input id="mInvite" placeholder="Código (si te invitaron)">
    </div>

    <div style="margin-top:10px"><span id="toggleMode" class="small" style="color:var(--accent);cursor:pointer">¿No tienes cuenta? Regístrate</span></div>
  </div>
</div>

<script>
/* ========================================================
   Brisa 1.0 (2025) — Implementación completa (single-file)
   - Local persistence via localStorage (STORE_KEY)
   - Invite codes stored with users; inviter relationship tracked
   - To be truly cross-device: integrate a backend (Firebase/Supabase)
   ======================================================== */

/* ---------- Config ---------- */
const STORE_KEY = 'brisa_1_users_v1';
const ACTIVE_KEY = 'brisa_1_active';
const app = {};

/* ---------- Utility helpers ---------- */
const $ = id => document.getElementById(id);
const qAll = sel => document.querySelectorAll(sel);
function toast(txt, t=2500){ const el=$('toast'); el.textContent=txt; el.style.display='block'; setTimeout(()=> el.style.display='none', t); }
function readStore(){ try{ return JSON.parse(localStorage.getItem(STORE_KEY) || '[]'); }catch(e){ return []; } }
function writeStore(data){ localStorage.setItem(STORE_KEY, JSON.stringify(data)); renderInvitations(); renderStats(); renderActiveUser(); }
function currentUser(){ return localStorage.getItem(ACTIVE_KEY) || ''; }
function setActive(u){ if(u) localStorage.setItem(ACTIVE_KEY, u); else localStorage.removeItem(ACTIVE_KEY); renderActiveUser(); renderInvitations(); renderStats(); }

/* ---------- Background: smooth neon + camo blobs ---------- */
const canvas = $('bg'); const ctx = canvas.getContext('2d');
function resize(){ canvas.width = innerWidth * devicePixelRatio; canvas.height = innerHeight * devicePixelRatio; canvas.style.width = innerWidth+'px'; canvas.style.height = innerHeight+'px'; ctx.setTransform(devicePixelRatio,0,0,devicePixelRatio,0,0); }
window.addEventListener('resize', resize); resize();

const palette = ['#37202b','#7a263f','#b43b5a','#12202a','#163044'];
const blobs = [];
for(let i=0;i<20;i++){ blobs.push({ x: Math.random()*innerWidth, y: Math.random()*innerHeight, r: 60 + Math.random()*220, vx:(Math.random()-0.5)*0.25, vy:(Math.random()-0.5)*0.25, c: palette[i%palette.length] }); }
let t0 = performance.now();
(function draw(now){
  const t = (now - t0) * 0.0005;
  ctx.clearRect(0,0,innerWidth,innerHeight);
  // large blobs
  blobs.forEach((b,i)=>{
    b.x += b.vx * Math.cos(t*(0.4 + i*0.02));
    b.y += b.vy * Math.sin(t*(0.3 + i*0.02));
    const g = ctx.createRadialGradient(b.x,b.y,b.r*0.05,b.x,b.y,b.r);
    g.addColorStop(0, hexRgba(b.c, 0.14));
    g.addColorStop(1, hexRgba(b.c, 0.02));
    ctx.beginPath(); ctx.fillStyle = g; ctx.arc(b.x,b.y,b.r,0,Math.PI*2); ctx.fill();
  });
  // neon ribbons
  for(let i=0;i<24;i++){
    const cx = (Math.sin(t*0.7 + i)*0.5 + 0.5) * innerWidth;
    const cy = (Math.cos(t*0.6 + i*0.6)*0.5 + 0.5) * innerHeight;
    const r = 180 + Math.sin(t*0.2 + i)*80;
    const g2 = ctx.createRadialGradient(cx,cy,r*0.1,cx,cy,r);
    g2.addColorStop(0, `rgba(123,226,255,${0.03 + (i%2)*0.02})`);
    g2.addColorStop(1, `rgba(255,77,122,0.012)`);
    ctx.beginPath(); ctx.fillStyle = g2; ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill();
  }
  // grain
  for(let i=0;i<400;i++){ ctx.fillStyle = `rgba(255,255,255,${(Math.random()-0.97)*0.02})`; ctx.fillRect(Math.random()*innerWidth, Math.random()*innerHeight, 1,1); }
  requestAnimationFrame(draw);
})(performance.now());
function hexRgba(hex,a){ const c = hex.replace('#',''); const n = parseInt(c,16); const r=(n>>16)&255,g=(n>>8)&255,b=n&255; return `rgba(${r},${g},${b},${a})`; }

/* ---------- Modal logic + blur animation ---------- */
const modal = $('modal'), pageWrap = $('pageWrap');
function showModal(mode='login'){ // mode: login | register
  modal.style.display='flex';
  applyBlur(true);
  if(mode==='login'){ $('modalTitle').textContent='Iniciar sesión'; $('modalPrimary').textContent='Entrar'; $('modalSecondary').textContent='Registrar'; $('toggleMode').textContent='¿No tienes cuenta? Regístrate'; $('modalMsg').textContent='Debes iniciar sesión o registrarte para guardar datos.'; } 
  else { $('modalTitle').textContent='Registrar cuenta'; $('modalPrimary').textContent='Registrar'; $('modalSecondary').textContent='Volver'; $('toggleMode').textContent='¿Ya tienes cuenta? Iniciar sesión'; $('modalMsg').textContent='Regístrate con un código (opcional)'; }
}
function hideModal(){ modal.style.display='none'; applyBlur(false); }
function applyBlur(on){
  if(on){ pageWrap.classList.add('blurOn'); } else { pageWrap.classList.remove('blurOn'); }
}

/* initial: require modal if no active user */
if(!currentUser()) showModal('login'); else hideModal();

/* toggle mode link */
$('toggleMode').addEventListener('click', ()=>{
  const isLogin = $('modalTitle').textContent.includes('Iniciar');
  showModal(isLogin ? 'register' : 'login');
});

/* primary button: login or register based on modal title */
$('modalPrimary').addEventListener('click', ()=>{
  const user = $('mUser').value.trim(); const pass = $('mPass').value.trim(); const invite = $('mInvite').value.trim().toUpperCase();
  if(user.length<3 || pass.length<3) { $('modalMsg').textContent='Usuario y contraseña mínimo 3 caracteres'; return; }
  const users = readStore();
  if($('modalTitle').textContent.includes('Iniciar')){
    const found = users.find(u => u.user === user && u.pass === pass);
    if(found){ setActive(user); hideModal(); toast('Sesión iniciada'); } else { $('modalMsg').textContent='Usuario/contraseña incorrectos'; }
  } else {
    if(users.find(u => u.user === user)){ $('modalMsg').textContent='Usuario ya existe'; return; }
    // register user, attach inviter if invite code present
    const newUser = { user, pass, created: new Date().toISOString(), history:[], invites:[], invitedBy: null, invited: [] , profile: { peso:'', nacimiento:'' } };
    if(invite){
      // find owner of invite
      const owner = users.find(u => (u.invites || []).includes(invite));
      if(owner){ newUser.invitedBy = owner.user; owner.invited = owner.invited || []; owner.invited.push(user); writeStore(users); } // update owner invited list
      else { $('modalMsg').textContent='Código inválido'; return; }
    }
    users.push(newUser); writeStore(users); setActive(user); hideModal(); toast('Registrado y conectado');
  }
});

/* secondary button toggles */
$('modalSecondary').addEventListener('click', ()=>{
  if($('modalTitle').textContent.includes('Iniciar')) showModal('register'); else showModal('login');
});

/* ---------- Navigation sidebar behavior ---------- */
qAll('.sideBtn').forEach(btn => btn.addEventListener('click', ()=> {
  qAll('.sideBtn').forEach(b=>b.classList.remove('active')); btn.classList.add('active');
  const view = btn.getAttribute('data-view');
  navigateTo(view);
}));

function navigateTo(view){
  $('pageTitle').textContent = view==='inicio' ? 'Inicio' : view==='juegos' ? 'Juegos' : view==='emociones' ? 'Registro de emociones' : view==='usuarios' ? 'Usuarios' : 'Perfil';
  $('pageSub').textContent = view==='inicio' ? 'Información y propósito' : '';
  // hide dynamic area then show relevant content
  $('dynamicArea').style.display = 'none';
  if(view==='inicio'){ /* show homepage (already visible) */ }
  else { renderView(view); $('dynamicArea').style.display = 'block'; window.scrollTo({top:0, behavior:'smooth'}); }
}

/* ---------- Renderers for views ---------- */
function renderView(view){
  const area = $('dynamicArea'); area.innerHTML = ''; 
  if(view==='juegos'){ renderGames(area); }
  if(view==='emociones'){ renderEmotions(area); }
  if(view==='usuarios'){ renderUsers(area); }
  if(view==='perfil'){ renderProfile(area); }
}

/* ---------- Games renderer & logic ---------- */
function renderGames(container){
  container.innerHTML = `
    <h3>Mini-juegos</h3>
    <div class="small" style="margin-top:6px">Juega y registra tu rendimiento.</div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn" id="playReaction">Reacción (mejorado)</button>
      <button class="btn" id="playSpatial">Habilidad mental (memoria espacial)</button>
      <button class="btn" id="playBreath">Respiración guiada</button>
    </div>
    <div id="gameArea" style="margin-top:12px"></div>
  `;
  // wiring
  $('playReaction').addEventListener('click', ()=> startReactionImproved($('gameArea')));
  $('playSpatial').addEventListener('click', ()=> startSpatialMemory($('gameArea')));
  $('playBreath').addEventListener('click', ()=> startBreathingGuide($('gameArea')));
}

/* reaction improved: better visuals, sound, countdown */
function startReactionImproved(host){
  host.innerHTML = `
    <div style="display:flex;flex-direction:column;align-items:center;gap:10px">
      <div style="font-weight:700">Reacción — presiona cuando el centro cambie</div>
      <div id="reactBox" style="width:220px;height:120px;border-radius:12px;background:linear-gradient(135deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01));display:flex;align-items:center;justify-content:center;font-size:18px;box-shadow:0 8px 30px rgba(0,0,0,0.5)">Preparar</div>
      <div id="reactRes" class="small"></div>
    </div>
  `;
  const box = host.querySelector('#reactBox'), res = host.querySelector('#reactRes');
  let start=null, tid=null, fake=false;
  box.addEventListener('click', ()=>{
    const activeUser = currentUser();
    if(!activeUser){ toast('Inicia sesión para jugar'); showModal('login'); return; }
    if(!start){ // start sequence
      box.textContent='...'; box.style.background='linear-gradient(135deg,#222,#111)'; box.style.transform='scale(.98)'; 
      // countdown with visual pulse
      let delay = Math.random()*2000 + 800;
      tid = setTimeout(()=>{ start = performance.now(); box.textContent='¡AHORA!'; box.style.background='linear-gradient(90deg,#6ef,#f66)'; box.style.transform='scale(1.02)'; playTone(880,0.06); }, delay);
      res.textContent='Espera el color...';
    } else { // user clicked after active
      const elapsed = Math.round(performance.now() - start);
      res.textContent = 'Tiempo: ' + elapsed + ' ms';
      storeGameResult({ game:'reaction', value: elapsed });
      addRecent(`Reacción: ${elapsed} ms`);
      start=null; clearTimeout(tid);
      // reset visual after small animation
      box.style.transition='transform .25s ease, background .25s ease';
      box.style.transform='scale(1)';
      setTimeout(()=>{ box.textContent='Preparar'; box.style.background='linear-gradient(135deg,rgba(255,255,255,0.02),rgba(255,255,255,0.01))'; }, 400);
    }
  });
}

/* spatial memory: grid positions - user must remember where icons appeared */
function startSpatialMemory(host){
  host.innerHTML = `<div style="display:flex;flex-direction:column;gap:10px;align-items:center"><div style="font-weight:700">Memoria espacial</div><div class="small">Recuerda las posiciones mostradas por 2-4 segundos y luego selecciónalas.</div><div id="spatialArea"></div><div id="spatialRes" class="small"></div></div>`;
  const area = host.querySelector('#spatialArea'), res = host.querySelector('#spatialRes');
  const size = 4; // 4x4 grid
  const cells = size*size;
  // choose random active indices
  const numTargets = 4; // can be adjusted for difficulty
  let indices = [];
  while(indices.length < numTargets){ const r = Math.floor(Math.random()*cells); if(!indices.includes(r)) indices.push(r); }
  // build grid
  const grid = document.createElement('div'); grid.className='grid-4'; grid.style.width='100%'; grid.style.maxWidth='520px';
  for(let i=0;i<cells;i++){
    const t = document.createElement('div'); t.className='tile'; t.dataset.index = i; t.innerText=''; grid.appendChild(t);
  }
  area.appendChild(grid);
  // reveal pattern briefly
  indices.forEach(i => { grid.children[i].classList.add('revealed'); grid.children[i].innerText='★'; });
  res.textContent = `Fíjate en las ${numTargets} posiciones...`;
  setTimeout(()=>{ // hide pattern
    indices.forEach(i => { grid.children[i].classList.remove('revealed'); grid.children[i].innerText=''; });
    res.textContent = 'Selecciona las posiciones recordadas';
    // allow selections
    let selected = [];
    for(let c=0;c<grid.children.length;c++){
      grid.children[c].addEventListener('click', function onClick(){
        if(selected.includes(c)) return; // not double-select
        this.classList.add('revealed'); this.innerText='✔';
        selected.push(c);
        if(selected.length === numTargets){
          // evaluate
          const correct = selected.filter(s => indices.includes(s)).length;
          res.textContent = `Acertaste ${correct} de ${numTargets}`;
          storeGameResult({ game:'spatial', value: `${correct}/${numTargets}` });
          addRecent(`Memoria espacial: ${correct}/${numTargets}`);
          // show the real pattern
          indices.forEach(i => { grid.children[i].classList.add('revealed'); grid.children[i].innerText='★'; });
          // cleanup: remove listeners
          for(let k=0;k<grid.children.length;k++) grid.children[k].replaceWith(grid.children[k].cloneNode(true));
        }
      });
    }
  }, 2200 + numTargets*200);
}

/* breathing guide */
let breathInt = null;
function startBreathingGuide(host){
  host.innerHTML = `<div style="display:flex;flex-direction:column;align-items:center;gap:12px"><div style="font-weight:700">Respiración 4-2-6</div><div id="breathCircle" style="width:120px;height:120px;border-radius:999px;background:linear-gradient(135deg, rgba(123,226,255,0.06), rgba(255,77,122,0.04));display:flex;align-items:center;justify-content:center">Respira</div><div><button class="btn" id="startB">Iniciar</button><button class="btn alt" id="stopB">Detener</button></div></div>`;
  const start = host.querySelector('#startB'), stop = host.querySelector('#stopB'), circle = host.querySelector('#breathCircle');
  start.addEventListener('click', ()=>{
    if(breathInt) clearInterval(breathInt);
    let s=0; breathInt = setInterval(()=>{ if(s===0) circle.style.transform='scale(1.4)'; else if(s===1) circle.style.transform='scale(1.6)'; else circle.style.transform='scale(1)'; s=(s+1)%3; }, 4000);
    addRecent('Respiración iniciada');
  });
  stop.addEventListener('click', ()=>{ if(breathInt) clearInterval(breathInt); setTimeout(()=>circle.style.transform='scale(1)',100); addRecent('Respiración detenida'); });
}

/* ---------- Emotions renderer ---------- */
function renderEmotions(container){
  const u = currentUser();
  container.innerHTML = `<h3>Registro de emociones</h3>
    <div class="small" style="margin-top:6px">Describe cómo te sientes y anota una nota breve.</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <select id="emoSelect"><option>Feliz</option><option>Triste</option><option>Ansioso</option><option>Calmado</option><option>Motivado</option></select>
      <input id="emoScore" placeholder="Puntuación 1-10 (opcional)">
    </div>
    <div style="margin-top:8px"><textarea id="emoNote" placeholder="Describe cómo estuvo tu día..."></textarea></div>
    <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" id="saveEmotionBtn">Guardar emoción</button><button class="btn alt" id="exportEmotionBtn">Exportar</button></div>
    <div id="emoTable" style="margin-top:10px"></div>
  `;
  $('saveEmotionBtn').addEventListener('click', ()=> {
    if(!currentUser()){ toast('Inicia sesión para guardar emociones'); showModal('login'); return; }
    const emotion = $('emoSelect').value; const score = parseInt($('emoScore').value) || null; const note = $('emoNote').value.trim();
    const users = readStore(); const user = users.find(x=>x.user===currentUser());
    user.history = user.history || []; user.history.push({ emotion, score, note, date: new Date().toISOString() });
    writeStore(users); toast('Emoción registrada', 1800); renderEmotions(container);
  });
  $('exportEmotionBtn').addEventListener('click', ()=>{
    if(!currentUser()){ toast('Inicia sesión para exportar'); return; }
    const u = currentUser(); const users = readStore(); const me = users.find(x=>x.user===u);
    const blob = new Blob([JSON.stringify(me.history || [], null, 2)], { type:'application/json' }); const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `brisa_emotions_${u}.json`; a.click(); URL.revokeObjectURL(url);
    toast('Historial exportado');
  });
  // render table
  const users = readStore(); const me = users.find(x=>x.user===u);
  const tableDiv = $('emoTable');
  if(!me || !me.history || me.history.length===0) { tableDiv.innerHTML = '<div class="small" style="margin-top:8px">No hay entradas</div>'; return; }
  const rows = me.history.slice().reverse().map(h => `<tr><td style="width:150px">${new Date(h.date).toLocaleString()}</td><td style="width:120px">${h.emotion}${h.score? ' • '+h.score : ''}</td><td>${(h.note||'')}</td></tr>`).join('');
  tableDiv.innerHTML = `<table class="table"><thead><tr><th>Fecha</th><th>Emoción (score)</th><th>Nota</th></tr></thead><tbody>${rows}</tbody></table>`;
}

/* ---------- Users renderer ---------- */
function renderUsers(container){
  const users = readStore();
  container.innerHTML = `<h3>Usuarios (${users.length})</h3><div class="small" style="margin-top:6px">Lista de usuarios registrados en este dispositivo (localStorage).</div><div id="userList" style="margin-top:8px"></div>`;
  const ul = $('userList');
  if(users.length===0){ ul.innerHTML='<div class="small">No hay usuarios</div>'; return; }
  ul.innerHTML = users.map(u => `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.02)"><strong>${u.user}</strong> • ${u.history?u.history.length:0} registros • <div class="small">Creado: ${new Date(u.created).toLocaleDateString()}</div><div class="small">Invitó: ${(u.invited||[]).length} • Invitado por: ${(u.invitedBy||'—')}</div></div>`).join('');
}

/* ---------- Profile renderer ---------- */
function renderProfile(container){
  const u = currentUser();
  if(!u){ container.innerHTML = `<div class="small">Inicia sesión para ver tu perfil.</div>`; return; }
  const users = readStore(); const me = users.find(x=>x.user===u);
  container.innerHTML = `
    <h3>Perfil • ${u}</h3>
    <div style="display:flex;gap:8px;margin-top:8px">
      <div style="flex:1">
        <label class="small">Peso (kg)</label>
        <input id="profilePeso" value="${me.profile?.peso || ''}" placeholder="ej: 70">
        <label class="small" style="margin-top:8px">Fecha de nacimiento</label>
        <input id="profileBirth" type="date" value="${me.profile?.nacimiento || ''}">
        <div style="display:flex;gap:8px;margin-top:10px"><button class="btn" id="saveProfileBtn">Guardar</button><button class="btn alt" id="delAccountBtn">Eliminar cuenta</button></div>
      </div>
      <div style="width:280px">
        <div class="card small"><strong>Invitaciones</strong><div id="myInviteCount" style="margin-top:6px">${(me.invites||[]).length} códigos</div></div>
        <div class="card small" style="margin-top:8px"><strong>Invitados</strong><div id="myInvitedList" style="margin-top:6px">${(me.invited||[]).length ? me.invited.join(', ') : '— ninguno —'}</div></div>
      </div>
    </div>
  `;
  $('saveProfileBtn').addEventListener('click', ()=>{
    me.profile = me.profile || {}; me.profile.peso = $('profilePeso').value.trim(); me.profile.nacimiento = $('profileBirth').value;
    writeStore(users); toast('Perfil guardado');
  });
  $('delAccountBtn').addEventListener('click', ()=>{
    if(!confirm('Eliminar cuenta: esto borrará el usuario localmente. Confirmar?')) return;
    const idx = users.findIndex(x=>x.user===u); if(idx>=0){ users.splice(idx,1); writeStore(users); setActive(''); showModal('register'); toast('Cuenta eliminada'); }
  });
}

/* ---------- Invite functions ---------- */
function renderInvitations(){
  const users = readStore();
  // build list of all codes
  const all = users.flatMap(u => (u.invites||[]).map(c => ({ code:c, by:u.user })));
  $('invBox').innerHTML = all.length ? all.map(x=>`<div style="padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)">${x.code} • ${x.by}</div>`).join('') : '— ninguna —';
}
function generateInviteForCurrent(){
  const u = currentUser(); if(!u){ toast('Inicia sesión para generar códigos'); showModal('login'); return; }
  const users = readStore(); const me = users.find(x=>x.user===u);
  const code = Math.random().toString(36).substring(2,9).toUpperCase();
  me.invites = me.invites || []; me.invites.push(code);
  writeStore(users); toast('Código generado: ' + code); renderInvitations();
}

/* ---------- Store game result + recent ---------- */
function storeGameResult(obj){
  if(!currentUser()) return;
  const users = readStore(); const me = users.find(u => u.user === currentUser());
  me.history = me.history || []; me.history.push({ emotion: obj.game || 'game', detail: obj.value, date: new Date().toISOString(), game:true });
  writeStore(users);
}

/* ---------- Small helpers: recent list & stats ---------- */
function addRecent(txt){
  const el = $('recent'); if(!el) return;
  const div = document.createElement('div'); div.style.padding='6px 0'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)'; div.className='small'; div.textContent = `${new Date().toLocaleTimeString()} — ${txt}`; el.prepend(div);
}
function renderStats(){
  const users = readStore();
  $('miniStat').textContent = `${users.length} users`;
  $('activeUser').textContent = currentUser() || '—';
  $('statUsers') && ($('statUsers').textContent = users.length);
  $('statRecords') && ($('statRecords').textContent = users.reduce((s,u)=>s + (u.history?u.history.length:0), 0));
  $('statCodes') && ($('statCodes').textContent = users.reduce((s,u)=>s + (u.invites?u.invites.length:0), 0));
}
function renderActiveUser(){ const u=currentUser(); $('activeUser').textContent = u || '—'; $('createdInfo').textContent = u ? ('creado: ' + new Date((readStore().find(x=>x.user===u)||{}).created || '').toLocaleDateString()) : ''; $('logoutBtn').style.display = u ? 'inline-block' : 'none'; }

/* ---------- Export / import ---------- */
$('exportAll').addEventListener('click', ()=> {
  const blob = new Blob([JSON.stringify(readStore(), null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'brisa_data_export.json'; a.click(); URL.revokeObjectURL(url); toast('Datos exportados');
});

/* ---------- UI events wiring ---------- */
$('btnReaction').addEventListener('click', ()=> navigateTo('juegos') || renderGames($('dynamicArea')));
$('btnSpatial').addEventListener('click', ()=> navigateTo('juegos') || renderGames($('dynamicArea')));
$('btnBreath').addEventListener('click', ()=> navigateTo('juegos') || renderGames($('dynamicArea')));
$('genInvite').addEventListener('click', generateInviteForCurrent);
$('showInv').addEventListener('click', ()=> { alert(readStore().flatMap(u => (u.invites||[]).map(c => `${c} — ${u.user}`)).join('\\n') || 'No hay códigos'); });

/* quick login area in top of dynamic area (on home) - keep simple: handle registration/login via modal */
qAll('.sideBtn').forEach(b => b.addEventListener('click', ()=> {})); // already wired

// Logout button
$('logoutBtn').addEventListener('click', ()=>{
  setActive(''); showModal('login'); toast('Sesión cerrada');
});

/* pressing Enter in modal triggers primary */
['mUser','mPass'].forEach(id => $(id).addEventListener('keydown', (e)=> { if(e.key==='Enter') $('modalPrimary').click(); }));

/* quick render functions invoked on initial load */
function renderInvitations(){ renderInvitationsInner(); renderInvitations(); } // placeholder
function renderInvitationsInner(){ /* noop to prevent errors when invoked before DOM ready */ }

/* export helper accessible */
window.generateInvite = generateInviteForCurrent;
window.redeemCode = function(){ const c=prompt('Codigo:'); if(!c) return; const owner = readStore().find(u => (u.invites||[]).includes(c.trim().toUpperCase())); if(owner){ alert('Codigo valido. Invitado por: ' + owner.user); } else alert('Codigo invalido'); };

/* ---------- Initial state ---------- */
// render initial stats & invites
renderStats(); renderInvitations();
// navigate to initial view
navigateTo('inicio');

/* If user interacted previously, show animation removing blur */
if(currentUser()){ applyBlur(false); hideModal(); }

// Demo shortcut (if no users, show a small initial demo button)
if(readStore().length===0){
  const demoBtn = document.createElement('button'); demoBtn.className='btn alt'; demoBtn.style.marginTop='10px'; demoBtn.textContent='Cargar demo'; demoBtn.onclick = ()=>{
    const users = readStore();
    users.push({ user:'alice', pass:'123', created: new Date().toISOString(), history:[{ emotion:'Feliz', note:'Buen día', date:new Date().toISOString() }], invites:['ABC123'], invitedBy:null, invited:[], profile:{} });
    users.push({ user:'santiago', pass:'abc', created: new Date().toISOString(), history:[{ emotion:'Ansioso', note:'Examen', date:new Date().toISOString() }], invites:[], invitedBy:null, invited:[], profile:{} });
    writeStore(users); renderStats(); toast('Demo cargada'); demoBtn.remove();
  };
  document.querySelector('#inicio .card').appendChild(demoBtn);
}

/* Small sound feedback */
const audioCtx = (window.AudioContext || window.webkitAudioContext) ? new (window.AudioContext || window.webkitAudioContext)() : null;
function playTone(freq=440, dur=0.06, vol=0.02){
  if(!audioCtx || !$('soundToggle').checked) return;
  const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
  o.connect(g); g.connect(audioCtx.destination); o.type='sine'; o.frequency.value = freq; g.gain.value = vol;
  o.start(); setTimeout(()=> o.stop(), dur*1000);
}

/* small convenience: refresh UI when store changes externally */
window.addEventListener('storage', (e)=>{
  if(e.key === STORE_KEY){ renderStats(); renderInvitations(); renderActiveUser(); }
});

/* NOTE ON MULTI-PLATFORM:
   - This implementation stores users & invites in localStorage (per-browser).
   - To make invites & users truly cross-device (multiplatform), connect to a backend
     (Firebase Realtime/Firestore, Supabase or your own API). I can add that integration
     next (instructions + code) if quieres sincronizar en la nube.
*/

</script>
</body>
</html>
